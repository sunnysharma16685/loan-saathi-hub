{% extends "base.html" %}

{% block title %}Complete Agent Profile - LoanSaathiHub{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2>Complete Your Agent Profile</h2>
  <form method="POST" action="{{ url_for('complete_profile_agent') }}">
    <!-- Basic Info - Readonly -->
    <div class="row mb-3">
      <div class="col-md-6">
        <label for="first_name" class="form-label">First Name</label>
        <input type="text" class="form-control" id="first_name" name="first_name" value="{{ user.first_name }}" readonly>
      </div>
      <div class="col-md-6">
        <label for="last_name" class="form-label">Last Name</label>
        <input type="text" class="form-control" id="last_name" name="last_name" value="{{ user.last_name }}" readonly>
      </div>
    </div>

    <div class="row mb-3">
      <div class="col-md-6">
        <label for="mobile" class="form-label">Mobile Number</label>
        <input type="text" class="form-control" id="mobile" name="mobile" value="{{ user.mobile }}" readonly>
      </div>
      <div class="col-md-6">
        <label for="email" class="form-label">Email ID</label>
        <input type="email" class="form-control" id="email" name="email" value="{{ user.email }}" readonly>
      </div>
    </div>

    <!-- Agent Type -->
    <div class="mb-3">
      <label for="agent_type" class="form-label">Type of Agent</label>
      <select class="form-select" id="agent_type" name="agent_type" required>
        <option value="" disabled selected>Select Agent Type</option>
        <option value="DSA" {% if user.agent_type == "DSA" %}selected{% endif %}>DSA</option>
        <option value="Bank or Finance" {% if user.agent_type == "Bank or Finance" %}selected{% endif %}>Bank or Finance</option>
        <option value="Private Firm" {% if user.agent_type == "Private Firm" %}selected{% endif %}>Private Firm</option>
      </select>
    </div>

    <!-- DSA fields -->
    <div id="dsa_fields" style="display:none;">
      <div class="mb-3">
        <label for="dsa_code" class="form-label">DSA Code</label>
        <input type="text" class="form-control" id="dsa_code" name="dsa_code" value="{{ user.dsa_code or '' }}">
      </div>
      <div class="mb-3">
        <label for="dsa_bank_name" class="form-label">Bank Name</label>
        <input type="text" class="form-control" id="dsa_bank_name" name="dsa_bank_name" value="{{ user.dsa_bank_name or '' }}">
      </div>
      <div class="mb-3">
        <label for="dsa_branch" class="form-label">Branch</label>
        <input type="text" class="form-control" id="dsa_branch" name="dsa_branch" value="{{ user.dsa_branch or '' }}">
      </div>
    </div>

    <!-- Bank or Finance fields -->
    <div id="bank_finance_fields" style="display:none;">
      <div class="mb-3">
        <label for="bf_branch" class="form-label">Branch Name</label>
        <input type="text" class="form-control" id="bf_branch" name="bf_branch" value="{{ user.bf_branch or '' }}">
      </div>
      <div class="mb-3">
        <label for="bf_name" class="form-label">Bank or Finance Name</label>
        <input type="text" class="form-control" id="bf_name" name="bf_name" value="{{ user.bf_name or '' }}">
      </div>
      <div class="mb-3">
        <label for="bf_designation" class="form-label">Designation</label>
        <input type="text" class="form-control" id="bf_designation" name="bf_designation" value="{{ user.bf_designation or '' }}">
      </div>
    </div>

    <!-- Private Firm fields -->
    <div id="private_firm_fields" style="display:none;">
      <div class="mb-3">
        <label for="firm_name" class="form-label">Firm Name</label>
        <input type="text" class="form-control" id="firm_name" name="firm_name" value="{{ user.firm_name or '' }}">
      </div>
      <div class="mb-3">
        <label for="gst_number" class="form-label">GST Number</label>
        <input type="text" class="form-control" id="gst_number" name="gst_number" value="{{ user.gst_number or '' }}">
      </div>
      <div class="mb-3">
        <label for="firm_address" class="form-label">Firm Address</label>
        <textarea class="form-control" id="firm_address" name="firm_address" rows="3">{{ user.firm_address or '' }}</textarea>
      </div>
    </div>

    <!-- Common Address Fields -->
    <div class="row mb-3">
      <div class="col-md-4">
        <label for="pincode" class="form-label">PIN Code <span class="text-danger">*</span></label>
        <input type="text" class="form-control" id="pincode" name="pincode" maxlength="6" value="{{ user.pincode or '' }}" required>
      </div>
      <div class="col-md-4">
        <label for="city" class="form-label">City <span class="text-danger">*</span></label>
        <input type="text" class="form-control" id="city" name="city" value="{{ user.city or '' }}" required>
      </div>
      <div class="col-md-4">
        <label for="state" class="form-label">State <span class="text-danger">*</span></label>
        <input type="text" class="form-control" id="state" name="state" value="{{ user.state or '' }}" required>
      </div>
    </div>

    <button type="submit" class="btn btn-primary mt-3">Submit Profile</button>
    <div class="d-flex justify-content-between align-items-center mt-3">
  <button type="button" onclick="history.back()" class="btn btn-secondary">Back</button>
  </div>

  </form>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const agentTypeSelect = document.getElementById("agent_type");
    const dsaFields = document.getElementById("dsa_fields");
    const bankFinanceFields = document.getElementById("bank_finance_fields");
    const privateFirmFields = document.getElementById("private_firm_fields");
    const pincodeInput = document.getElementById("pincode");
    const cityInput = document.getElementById("city");
    const stateInput = document.getElementById("state");

    function toggleAgentFields() {
      const val = agentTypeSelect.value;
      dsaFields.style.display = "none";
      bankFinanceFields.style.display = "none";
      privateFirmFields.style.display = "none";

      if (val === "DSA") {
        dsaFields.style.display = "block";
      } else if (val === "Bank or Finance") {
        bankFinanceFields.style.display = "block";
      } else if (val === "Private Firm") {
        privateFirmFields.style.display = "block";
      }
    }

    agentTypeSelect.addEventListener("change", toggleAgentFields);
    toggleAgentFields();

    // Auto-fill city and state by PIN code using Indian Postal API
    pincodeInput.addEventListener("blur", function () {
      const pin = pincodeInput.value.trim();
      if (pin.length === 6) {
        fetch(`https://api.postalpincode.in/pincode/${pin}`)
          .then(response => response.json())
          .then(data => {
            if (data[0].Status === "Success") {
              const postOffice = data[0].PostOffice[0];
              cityInput.value = postOffice.District;
              stateInput.value = postOffice.State;
            } else {
              cityInput.value = "";
              stateInput.value = "";
            }
          })
          .catch(() => {
            cityInput.value = "";
            stateInput.value = "";
          });
      }
    });
  });
</script>

{% endblock %}
