{% extends "base.html" %}
{% load static %}

{% block title %}Login — Loan Saathi Hub{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-md-6 col-lg-5">
    <div class="card shadow-lg border-0 rounded-4 p-4">
      <!-- Header -->
      <div class="text-center mb-4">
        <div class="rounded-circle bg-light d-inline-flex align-items-center justify-content-center mb-3" style="width:60px;height:60px;">
          <i class="bi bi-person-lock text-primary fs-3"></i>
        </div>
        <h3 class="fw-bold mb-1">Welcome Back</h3>
        <p class="text-muted mb-0">Login to access your account</p>
      </div>

      <!-- ✅ Messages -->
      {% if messages %}
        <div class="mb-3">
          {% for message in messages %}
            <div class="alert 
                        {% if 'error' in message.tags %}alert-danger
                        {% elif 'warning' in message.tags %}alert-warning
                        {% elif 'success' in message.tags %}alert-success
                        {% else %}alert-info{% endif %}
                        alert-dismissible fade show small shadow-sm" role="alert">
              {{ message }}
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
          {% endfor %}
        </div>
      {% endif %}

      <!-- Form -->
      <form method="POST" id="loginForm" novalidate action="{% url 'login' %}">
        {% csrf_token %}

        <!-- Role -->
        <div class="mb-3">
          <label for="role" class="form-label fw-semibold">Login as</label>
          {% if role %}
            {% with selected_role=role %}
              <select name="role" id="role" class="form-select" required autocomplete="off">
                <option value="">-- Select Role --</option>
                <option value="applicant" {% if selected_role == "applicant" %}selected{% endif %}>Applicant</option>
                <option value="lender" {% if selected_role == "lender" %}selected{% endif %}>Lender</option>
              </select>
            {% endwith %}
          {% else %}
            {% with selected_role=request.GET.role|default:"" %}
              <select name="role" id="role" class="form-select" required autocomplete="off">
                <option value="">-- Select Role --</option>
                <option value="applicant" {% if selected_role == "applicant" %}selected{% endif %}>Applicant</option>
                <option value="lender" {% if selected_role == "lender" %}selected{% endif %}>Lender</option>
              </select>
            {% endwith %}
          {% endif %}
        </div>

        <!-- Email -->
        <div class="mb-3">
          <label for="email" class="form-label fw-semibold">Email</label>
          {% if email %}
            <input type="email" name="email" id="email" class="form-control"
                   value="{{ email }}" required autocomplete="email" autofocus>
          {% elif request.POST.email %}
            <input type="email" name="email" id="email" class="form-control"
                   value="{{ request.POST.email }}" required autocomplete="email" autofocus>
          {% else %}
            <input type="email" name="email" id="email" class="form-control"
                   value="" required autocomplete="email" autofocus>
          {% endif %}
        </div>

        <!-- Password -->
        <div class="mb-3">
          <label for="password" class="form-label fw-semibold">Password</label>
          <div class="input-group">
            <input type="password" 
                   name="password" 
                   id="password" 
                   class="form-control" 
                   required 
                   autocomplete="current-password">
            <button type="button" class="btn btn-outline-secondary" id="togglePassword">
              <i class="bi bi-eye"></i>
            </button>
          </div>
        </div>

        <!-- Submit -->
        <div class="d-grid mt-4">
          <button type="submit" class="btn btn-primary btn-lg rounded-3 shadow-sm">
            <i class="bi bi-box-arrow-in-right me-1"></i> Login
          </button>
        </div>

        <!-- Links -->
        <div class="text-center mt-4 small">
          <a href="{% url 'forgot_password' %}" class="text-decoration-none">Forgot password?</a> &nbsp;|&nbsp;
          <a href="{% url 'register' %}" class="text-decoration-none fw-semibold">New user? Register</a>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function(){
  const form = document.getElementById('loginForm');
  if (!form) return;

  // Form validation
  form.addEventListener('submit', function(e){
    const role = (document.getElementById('role')?.value || '').trim();
    const email = (document.getElementById('email')?.value || '').trim();
    const password = document.getElementById('password')?.value || '';

    if (!role) {
      e.preventDefault();
      alert('⚠️ Please select a role (Applicant or Lender).');
      return;
    }
    if (!email || !password) {
      e.preventDefault();
      alert('⚠️ Please enter both email and password.');
      return;
    }
  }, { passive: false });

  // Password show/hide
  const togglePassword = document.getElementById('togglePassword');
  if (togglePassword) {
    togglePassword.addEventListener('click', function(){
      const passwordInput = document.getElementById('password');
      const icon = this.querySelector('i');
      if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        icon.classList.remove('bi-eye');
        icon.classList.add('bi-eye-slash');
      } else {
        passwordInput.type = 'password';
        icon.classList.remove('bi-eye-slash');
        icon.classList.add('bi-eye');
      }
    });
  }
})();
</script>
{% endblock %}
