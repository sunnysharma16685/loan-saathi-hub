{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Complete Profile (User) - LoanSaathiHub</title>

  <!-- Google Font (same as index look) -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --primary:#0d6efd;      /* LoanSaathiHub blue */
      --primary-dark:#0b5ed7;
      --text:#212529;
      --muted:#6c757d;
      --bg:#f8f9fa;
      --card:#ffffff;
      --success:#28a745;
      --danger:#dc3545;
      --border:#e9ecef;
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      font-family:'Poppins',sans-serif;
      background:var(--bg);
      color:var(--text);
      margin:0;
    }

    /* Header (same feel as index) */
    .top-bar{
      background:#fff;
      padding:14px 20px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      border-bottom:1px solid var(--border);
      position:sticky;
      top:0;
      z-index:10;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:700;
      font-size:20px;
      color:var(--text);
      text-decoration:none;
    }
    .brand img{height:40px; border-radius:8px}
    .top-actions{display:flex; gap:10px}
    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      padding:10px 16px; border-radius:10px; font-weight:600;
      border:1px solid transparent; cursor:pointer; text-decoration:none;
    }
    .btn-primary{background:var(--primary); color:#fff}
    .btn-primary:hover{background:var(--primary-dark)}
    .btn-light{background:#fff; color:var(--primary); border-color:var(--primary)}
    .btn-light:hover{background:#f0f6ff}

    /* Container + stepper */
    .container{max-width:1000px; margin:30px auto; padding:0 16px}
    .stepper{
      display:flex; gap:16px; justify-content:center; align-items:center;
      margin-bottom:20px; flex-wrap:wrap;
    }
    .step{
      display:flex; align-items:center; gap:10px;
      padding:10px 14px; background:#fff; border:1px solid var(--border);
      border-radius:12px; min-width:220px;
    }
    .step .badge{
      width:28px; height:28px; border-radius:50%; display:grid; place-items:center;
      background:#e9f2ff; color:var(--primary); font-weight:700;
      border:1px solid #d7e6ff;
    }
    .step.active{border-color:var(--primary)}
    .step.active .badge{background:var(--primary); color:#fff; border-color:var(--primary)}
    .step.done{opacity:.8}
    .step small{color:var(--muted); font-weight:500}

    /* Card */
    .card{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:0 6px 24px rgba(0,0,0,.06);
      padding:24px;
      border:1px solid var(--border);
    }

    h2{margin:0 0 6px 0; color:var(--primary); font-weight:700; font-size:22px}
    .sub{color:var(--muted); margin-bottom:18px}

    /* Grid fields */
    .grid{
      display:grid; grid-template-columns:1fr 1fr; gap:16px;
    }
    .grid-1{grid-template-columns:1fr}
    @media (max-width:720px){ .grid{grid-template-columns:1fr} }

    label{font-weight:600; font-size:13px; color:#333}
    input, select, textarea{
      width:100%; padding:12px 14px; border:1px solid #ced4da; border-radius:10px;
      font-size:14px; outline:none; background:#fff;
    }
    textarea{min-height:96px; resize:vertical}
    input:focus, select:focus, textarea:focus{
      border-color:var(--primary);
      box-shadow:0 0 0 3px rgba(13,110,253,.15);
    }
    .hint{font-size:12px; color:var(--muted); margin-top:4px}

    .actions{
      display:flex; gap:10px; justify-content:flex-end; margin-top:10px;
      flex-wrap:wrap;
    }
    .btn-secondary{
      background:#fff; color:#333; border:1px solid var(--border);
    }
    .btn-success{background:var(--success); color:#fff}
    .btn-danger{background:var(--danger); color:#fff}

    .inline{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
    }
    .otp-note{font-size:12px; color:var(--muted)}
    .status{
      padding:6px 10px; border-radius:8px; font-size:12px; font-weight:600;
      background:#eef7ff; color:var(--primary); border:1px solid #d7e6ff;
    }
    .status.ok{background:#eaf7ee; color:#1e7e34; border-color:#cfead6}
    .status.bad{background:#fdecec; color:#b02a37; border-color:#f5c2c7}

    /* Hide sections */
    .hidden{display:none}

    /* Footer (same vibe as index) */
    footer{
      margin:40px 0 20px;
      text-align:center; color:#6c757d; font-size:13px;
    }
  </style>
</head>
<body>

  <!-- Header -->
  <header class="top-bar">
    <a class="brand" href="/">
      <img src="{% static 'logo.png' %}" alt="LoanSaathiHub Logo"/>
      <span>LoanSaathiHub</span>
    </a>
    <div class="top-actions">
      <a class="btn btn-light" href="/">Home</a>
      <a class="btn btn-primary" href="/login">Login</a>
    </div>
  </header>

  <main class="container">
    <!-- Stepper -->
    <div class="stepper" id="stepper">
      <div class="step active" data-step="1">
        <div class="badge">1</div>
        <div>
          <div><strong>Basic Profile</strong></div>
          <small>Title, Name, Mobile OTP, Email & Password</small>
        </div>
      </div>
      <div class="step" data-step="2">
        <div class="badge">2</div>
        <div>
          <div><strong>Personal Profile</strong></div>
          <small>DOB, Address, PAN, Aadhaar, ITR, CIBIL</small>
        </div>
      </div>
      <div class="step" data-step="3">
        <div class="badge">3</div>
        <div>
          <div><strong>Job or Business</strong></div>
          <small>Employment / Business details</small>
        </div>
      </div>
    </div>

    <form id="profileForm" class="card" autocomplete="off">
      <!-- STEP 1: Basic Profile -->
      <section id="step-1">
        <h2>Step 1: Basic Profile</h2>
        <div class="sub">Please fill your basic details and verify mobile via OTP (demo mode).</div>

        <div class="grid">
          <div>
            <label for="title">Title</label>
            <select id="title" required>
              <option value="">Select</option>
              <option>Mr</option>
              <option>Ms</option>
              <option>Mrs</option>
              <option>Dr</option>
            </select>
          </div>
          <div>
            <label for="firstName">First Name</label>
            <input id="firstName" type="text" required placeholder="Enter first name"/>
          </div>
          <div>
            <label for="lastName">Last Name</label>
            <input id="lastName" type="text" required placeholder="Enter last name"/>
          </div>
          <div>
            <label for="mobile">Mobile (10 digits)</label>
            <div class="inline">
              <input id="mobile" type="tel" pattern="^[0-9]{10}$" maxlength="10" placeholder="e.g. 9876543210" required/>
              <button type="button" class="btn btn-light" id="sendOtpBtn">Send OTP</button>
            </div>
            <div class="hint otp-note" id="otpInfo">OTP not sent yet.</div>
          </div>

          <div class="grid-1" style="grid-column:1/-1">
            <label for="otp">Enter OTP (demo)</label>
            <div class="inline">
              <input id="otp" type="text" inputmode="numeric" maxlength="6" placeholder="6-digit OTP"/>
              <button type="button" class="btn btn-secondary" id="verifyOtpBtn">Verify OTP</button>
              <span id="otpStatus" class="status">Not verified</span>
            </div>
          </div>

          <div>
            <label for="email">Email</label>
            <input id="email" type="email" required placeholder="name@example.com"/>
          </div>
          <div>
            <label for="password">Create Password</label>
            <input id="password" type="password" minlength="8" required placeholder="Min 8 characters"/>
          </div>
          <div>
            <label for="confirmPassword">Reconfirm Password</label>
            <input id="confirmPassword" type="password" minlength="8" required placeholder="Re-enter password"/>
          </div>
          <input type="hidden" id="password_hash" name="password_hash" />
        </div>

        <div class="actions">
          <button type="button" class="btn btn-primary" id="next1">Save & Next</button>
        </div>
      </section>

      <!-- STEP 2: Personal Profile -->
      <section id="step-2" class="hidden">
        <h2>Step 2: Personal Profile</h2>
        <div class="sub">Enter your personal and KYC information.</div>

        <div class="grid">
          <div>
            <label for="dob">Date of Birth</label>
            <input id="dob" type="date" required/>
          </div>
          <div>
            <label>Gender</label>
            <div class="inline">
              <label class="inline"><input type="radio" name="gender" value="Male" required/> Male</label>
              <label class="inline"><input type="radio" name="gender" value="Female"/> Female</label>
              <label class="inline"><input type="radio" name="gender" value="Other"/> Other</label>
            </div>
          </div>

          <div class="grid-1" style="grid-column:1/-1">
            <label for="address">Full Address</label>
            <textarea id="address" placeholder="House No, Street, Area, Landmark"></textarea>
          </div>

          <div>
            <label for="pincode">PIN Code</label>
            <input id="pincode" type="text" pattern="^[0-9]{6}$" maxlength="6" placeholder="e.g. 110001" required/>
            <div class="hint">City & State will auto-fill after valid PIN.</div>
          </div>
          <div>
            <label for="city">City</label>
            <input id="city" type="text" placeholder="Auto-filled" />
          </div>
          <div>
            <label for="state">State</label>
            <input id="state" type="text" placeholder="Auto-filled" />
          </div>

          <div>
            <label for="pan">PAN Number (Mandatory)</label>
            <input id="pan" type="text" placeholder="ABCDE1234F" maxlength="10" required/>
            <div class="hint">Format: 5 letters + 4 digits + 1 letter</div>
          </div>
          <div>
            <label for="aadhaar">Aadhaar Number</label>
            <input id="aadhaar" type="text" pattern="^[0-9]{12}$" maxlength="12" placeholder="12-digit UIDAI"/>
          </div>

          <div>
            <label for="itr">ITR</label>
            <select id="itr" required>
              <option value="">Select</option>
              <option>Last 3 years</option>
              <option>Last 2 years</option>
              <option>Last 1 year</option>
              <option>No ITR</option>
            </select>
          </div>
          <div>
            <label for="cibil">CIBIL Score</label>
            <input id="cibil" type="number" min="300" max="900" placeholder="300-900"/>
          </div>
        </div>

        <div class="actions">
          <button type="button" class="btn btn-secondary" id="back2">Back</button>
          <button type="button" class="btn btn-primary" id="next2">Save & Next</button>
        </div>
      </section>

      <!-- STEP 3: Job or Business -->
      <section id="step-3" class="hidden">
        <h2>Step 3: Job or Business</h2>
        <div class="sub">Provide your employment/business details.</div>

        <!-- Selector -->
        <div class="inline" style="margin-bottom:10px">
          <label class="inline"><input type="radio" name="type" value="job" required> Job</label>
          <label class="inline"><input type="radio" name="type" value="business"> Business</label>
        </div>

        <!-- Job Fields -->
        <div id="job-fields" class="hidden">
          <div class="grid">
            <div>
              <label>Job Type</label>
              <select id="jobType">
                <option value="">Select Job Type</option>
                <option value="full-time">Full-time</option>
                <option value="part-time">Part-time</option>
                <option value="temporary">Temporary</option>
                <option value="contract">Contract</option>
                <option value="internship">Internship</option>
              </select>
            </div>
            <div>
              <label>Employment Type</label>
              <select id="employmentType">
                <option value="">Select Employment Type</option>
                <option value="government">Government</option>
                <option value="private-ltd">Private Ltd</option>
                <option value="ltd">Ltd</option>
                <option value="llp">LLP</option>
                <option value="proprietor">Proprietor</option>
              </select>
            </div>
            <div>
              <label>Company Name</label>
              <input id="companyName" type="text" placeholder="Enter Company Name">
            </div>
            <div>
              <label>Designation</label>
              <select id="jobDesignation">
                <option value="">Select Designation</option>
                <option value="junior">Junior</option>
                <option value="senior">Senior</option>
                <option value="manager">Manager</option>
                <option value="executive">Executive</option>
                <option value="director">Director</option>
                <option value="partner">Partner</option>
              </select>
            </div>
            <div>
              <label>Total Work Experience (years)</label>
              <input id="totalExperience" type="number" min="0" placeholder="e.g. 5">
            </div>
            <div>
              <label>Current Company Experience (years)</label>
              <input id="currentExperience" type="number" min="0" placeholder="e.g. 2">
            </div>
            <div>
              <label>Mode of Salary</label>
              <select id="salaryMode">
                <option value="">Select Salary Mode</option>
                <option value="bank">Bank</option>
                <option value="cash">Cash</option>
                <option value="cheque">Cheque</option>
              </select>
            </div>
            <div>
              <label>Monthly Salary (₹)</label>
              <input id="monthlySalary" type="number" min="0" placeholder="Enter Salary">
            </div>
            <div class="grid-1" style="grid-column:1/-1">
              <label>Other Income (Bonus, Incentives etc.)</label>
              <input id="otherIncome" type="number" min="0" placeholder="Enter other income">
            </div>
          </div>
        </div>

        <!-- Business Fields -->
        <div id="business-fields" class="hidden">
          <div class="grid">
            <div>
              <label>Last Year Company Turnover (₹)</label>
              <input id="businessTurnover" type="number" min="0" placeholder="Enter Company Turnover">
            </div>
            <div>
              <label>Designation</label>
              <select id="businessDesignation">
                <option value="">Select Designation</option>
                <option value="director">Director</option>
                <option value="ceo">CEO</option>
                <option value="owner">Owner</option>
                <option value="proprietor">Proprietor</option>
                <option value="partner">Partner</option>
              </select>
            </div>
          </div>
        </div>

        <div class="actions">
          <button type="button" class="btn btn-secondary" id="back3">Back</button>
          <button type="submit" class="btn btn-success">Save & Finish</button>
        </div>
      </section>
    </form>
  </main>

  <footer>
    &copy; 2025 LoanSaathiHub. All rights reserved. | Terms &amp; Conditions | Privacy Policy
  </footer>

  <script>
    // ----- State -----
    let currentStep = 1;
    let generatedOTP = null;
    let otpVerified = false;

    // Step toggling
    function showStep(n){
      currentStep = n;
      document.getElementById('step-1').classList.toggle('hidden', n!==1);
      document.getElementById('step-2').classList.toggle('hidden', n!==2);
      document.getElementById('step-3').classList.toggle('hidden', n!==3);
      // stepper UI
      [...document.querySelectorAll('.stepper .step')].forEach((el,i)=>{
        el.classList.toggle('active', i===n-1);
        el.classList.toggle('done', i < n-1);
        el.querySelector('.badge').textContent = (i < n-1) ? '✓' : (i+1);
      });
    }

    // OTP (Demo)
    const sendOtpBtn = document.getElementById('sendOtpBtn');
    const verifyOtpBtn = document.getElementById('verifyOtpBtn');
    const otpInfo = document.getElementById('otpInfo');
    const otpInput = document.getElementById('otp');
    const otpStatus = document.getElementById('otpStatus');

    function randomOTP(){
      return Math.floor(100000 + Math.random()*900000).toString();
    }

    sendOtpBtn?.addEventListener('click', ()=>{
      const mobile = document.getElementById('mobile').value.trim();
      if(!/^[0-9]{10}$/.test(mobile)){ alert('Please enter a valid 10-digit mobile number.'); return; }
      generatedOTP = randomOTP();
      otpVerified = false;
      otpStatus.textContent = 'OTP sent. Not verified';
      otpStatus.className = 'status';
      otpInfo.textContent = `Demo OTP (for testing): ${generatedOTP}`;
    });

    verifyOtpBtn?.addEventListener('click', ()=>{
      if(!generatedOTP){ alert('Please click "Send OTP" first.'); return; }
      if(otpInput.value.trim() === generatedOTP){
        otpVerified = true;
        otpStatus.textContent = 'Verified';
        otpStatus.className = 'status ok';
      }else{
        otpVerified = false;
        otpStatus.textContent = 'Invalid OTP';
        otpStatus.className = 'status bad';
      }
    });

    // SHA-256 hashing (Web Crypto)
    async function sha256(message){
      const msgBuffer = new TextEncoder().encode(message);
      const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      return hashArray.map(b => b.toString(16).padStart(2,'0')).join('');
    }

    // Step 1 -> Next
    document.getElementById('next1').addEventListener('click', async ()=>{
      // validations
      const title = document.getElementById('title').value.trim();
      const firstName = document.getElementById('firstName').value.trim();
      const lastName = document.getElementById('lastName').value.trim();
      const mobile = document.getElementById('mobile').value.trim();
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      const confirmPassword = document.getElementById('confirmPassword').value;

      if(!title || !firstName || !lastName || !/^[0-9]{10}$/.test(mobile) || !email){
        alert('Please complete all required fields correctly.');
        return;
      }
      if(!otpVerified){
        alert('Please verify OTP to proceed.');
        return;
      }
      if(password.length < 8){ alert('Password must be at least 8 characters.'); return; }
      if(password !== confirmPassword){ alert('Passwords do not match.'); return; }

      const hash = await sha256(password);
      document.getElementById('password_hash').value = hash;
      // clear plaintext for safety
      document.getElementById('password').value = '';
      document.getElementById('confirmPassword').value = '';
      showStep(2);
    });

    // Back / Next in Step 2
    document.getElementById('back2').addEventListener('click', ()=> showStep(1));
    document.getElementById('next2').addEventListener('click', ()=>{
      // validations step 2
      const dob = document.getElementById('dob').value;
      const gender = (document.querySelector('input[name="gender"]:checked')||{}).value;
      const pincode = document.getElementById('pincode').value.trim();
      const pan = document.getElementById('pan').value.trim().toUpperCase();
      const itr = document.getElementById('itr').value;

      if(!dob || !gender || !/^[0-9]{6}$/.test(pincode) || !itr){
        alert('Please complete required fields (DOB, Gender, PIN, ITR).');
        return;
      }
      if(!/^[A-Z]{5}[0-9]{4}[A-Z]{1}$/.test(pan)){
        alert('Please enter a valid PAN (e.g., ABCDE1234F).');
        return;
      }
      // Aadhaar optional validation if provided
      const aadhaar = document.getElementById('aadhaar').value.trim();
      if(aadhaar && !/^\d{12}$/.test(aadhaar)){
        alert('Please enter a valid 12-digit Aadhaar or leave blank.');
        return;
      }
      const cibil = document.getElementById('cibil').value;
      if(cibil && (Number(cibil) < 300 || Number(cibil) > 900)){
        alert('CIBIL must be between 300 and 900.');
        return;
      }
      showStep(3);
    });

    // Back in Step 3
    document.getElementById('back3').addEventListener('click', ()=> showStep(2));

    // Job/Business toggle
    const typeRadios = document.querySelectorAll('input[name="type"]');
    const jobFields = document.getElementById('job-fields');
    const businessFields = document.getElementById('business-fields');
    typeRadios.forEach(r=>{
      r.addEventListener('change', ()=>{
        const v = document.querySelector('input[name="type"]:checked')?.value;
        jobFields.classList.toggle('hidden', v!=='job');
        businessFields.classList.toggle('hidden', v!=='business');
      });
    });

    // PIN -> City/State (API + fallback)
    const pinMap = {
      "110001": { city:"New Delhi", state:"Delhi" },
      "400001": { city:"Mumbai", state:"Maharashtra" },
      "560001": { city:"Bengaluru", state:"Karnataka" },
      "700001": { city:"Kolkata", state:"West Bengal" },
      "600001": { city:"Chennai", state:"Tamil Nadu" }
    };
    async function fillCityState(pincode){
      const cityEl = document.getElementById('city');
      const stateEl = document.getElementById('state');
      cityEl.value = ''; stateEl.value = '';

      if(pinMap[pincode]){
        cityEl.value = pinMap[pincode].city;
        stateEl.value = pinMap[pincode].state;
        return;
      }
      try{
        const res = await fetch(`https://api.postalpincode.in/pincode/${pincode}`);
        const data = await res.json();
        if(Array.isArray(data) && data[0]?.Status === "Success"){
          const office = data[0].PostOffice?.[0];
          if(office){
            cityEl.value = office.District || '';
            stateEl.value = office.State || '';
          }
        }
      }catch(e){
        // ignore (fallback already tried)
      }
    }
    document.getElementById('pincode').addEventListener('input', (e)=>{
      const p = e.target.value.trim();
      if(/^\d{6}$/.test(p)){ fillCityState(p); }
    });

    // Final submit => gather all data
    document.getElementById('profileForm').addEventListener('submit', (e)=>{
      e.preventDefault();
      // Gather Step 1
      const payload = {
        basic:{
          title: document.getElementById('title').value.trim(),
          firstName: document.getElementById('firstName').value.trim(),
          lastName: document.getElementById('lastName').value.trim(),
          mobile: document.getElementById('mobile').value.trim(),
          email: document.getElementById('email').value.trim(),
          password_hash: document.getElementById('password_hash').value,
          otpVerified
        },
        personal:{
          dob: document.getElementById('dob').value,
          gender: (document.querySelector('input[name="gender"]:checked')||{}).value || '',
          address: document.getElementById('address').value,
          pincode: document.getElementById('pincode').value.trim(),
          city: document.getElementById('city').value,
          state: document.getElementById('state').value,
          pan: document.getElementById('pan').value.trim().toUpperCase(),
          aadhaar: document.getElementById('aadhaar').value.trim(),
          itr: document.getElementById('itr').value,
          cibil: document.getElementById('cibil').value
        },
        work:{
          type: (document.querySelector('input[name="type"]:checked')||{}).value || '',
          job:{
            jobType: document.getElementById('jobType')?.value || '',
            employmentType: document.getElementById('employmentType')?.value || '',
            companyName: document.getElementById('companyName')?.value || '',
            jobDesignation: document.getElementById('jobDesignation')?.value || '',
            totalExperience: document.getElementById('totalExperience')?.value || '',
            currentExperience: document.getElementById('currentExperience')?.value || '',
            salaryMode: document.getElementById('salaryMode')?.value || '',
            monthlySalary: document.getElementById('monthlySalary')?.value || '',
            otherIncome: document.getElementById('otherIncome')?.value || ''
          },
          business:{
            businessTurnover: document.getElementById('businessTurnover')?.value || '',
            businessDesignation: document.getElementById('businessDesignation')?.value || ''
          }
        }
      };
      console.log('Complete Profile Payload:', payload);
      alert('Profile saved (demo). Check console for payload.');
      // TODO: send payload via fetch('/your-endpoint', {method:'POST', body:JSON.stringify(payload)})
    });

    // init
    showStep(1);
  </script>
</body>
</html>
