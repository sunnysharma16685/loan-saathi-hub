{% extends "base.html" %}
{% load static %}

{% block title %}Partial Profile | Loan Saathi Hub{% endblock %}

{% block extra_head %}
<style>
  .profile-container { max-width: 950px; margin: 30px auto; }
  h2, h4 { color:#0d6efd; font-weight:600; }
  .card {
    background:#fff; padding:20px; border-radius:12px;
    box-shadow:0 6px 18px rgba(0,0,0,0.08); margin-bottom:20px;
  }
  .card h4 { margin-bottom:15px; }
  .card p { margin-bottom:8px; color:#444; }
  table { width:100%; border-collapse:collapse; margin-top:10px; }
  table th, table td { border:1px solid #e9ecef; padding:10px; }
  table th { background:#0d6efd; color:#fff; font-weight:600; }
  .btn-generate { background:#0d6efd; color:#fff; font-weight:600; padding:6px 14px; border-radius:6px; }
  .btn-generate:disabled { background:#adb5bd; cursor:not-allowed; }
  .btn-back { background:#6c757d; color:#fff; font-weight:600; padding:10px 16px; border-radius:6px; text-decoration:none; }
</style>
{% endblock %}

{% block content %}
<div class="profile-container">
  <h2>Partial Profile (Limited Access)</h2>

  <!-- ‚úÖ Alerts -->
  <div id="alertBox"></div>

  <!-- ‚úÖ Basic Info -->
  <div class="card">
    <h4>Basic Information</h4>
    <p><strong>Full Name:</strong> {{ profile.full_name|default:"N/A" }}</p>
    <p><strong>Email:</strong> **********</p>
    <p><strong>Mobile:</strong> **********</p>
    <p><strong>Gender:</strong> {{ profile.gender|default:"N/A" }}</p>
    <p><strong>Marital Status:</strong> {{ profile.marital_status|default:"N/A" }}</p>
    <p><strong>Address:</strong> **********, {{ profile.city|default:"" }}, {{ profile.state|default:"" }} - {{ profile.pincode|default:"N/A" }}</p>
    <p><strong>PAN:</strong> {{ profile.pancard_number|default:"N/A" }}</p>
    <p><strong>Aadhaar:</strong> **********</p>
    <p><strong>Date of Birth:</strong> {{ profile.dob|date:"d-m-Y"|default:"N/A" }}</p>
  </div>

  <!-- ‚úÖ Applicant Details -->
  {% if applicant_details %}
  <div class="card">
    <h4>Applicant Details</h4>
    <p><strong>Job Type:</strong> {{ applicant_details.job_type|default:"N/A" }}</p>
    <p><strong>Employment Type:</strong> {{ applicant_details.employment_type|default:"N/A" }}</p>

    <!-- ‚úÖ CIBIL Score Section -->
    <p><strong>CIBIL Score:</strong></p>
    <div id="cibilSection">
      {% if applicant_details.cibil_score %}
        <input type="text" id="cibilScoreInput" class="form-control" 
               value="{{ applicant_details.cibil_score }}" readonly style="max-width:220px; background:#f8f9fa;">
        <small class="text-muted d-block mt-1" id="cibilMeta">
          Generated on {{ applicant_details.cibil_last_generated|date:"d/m/Y h:i A"|default:"N/A" }}
          {% if applicant_details.cibil_locked_until %}
            <br>üîí Next generation available after:
            <strong>{{ applicant_details.cibil_locked_until|date:"d-m-Y" }}</strong>
          {% endif %}
        </small>
      {% else %}
        {% if request.user.role == "lender" %}
          <button id="generateCibilBtn" 
                  data-url="{% url 'generate_cibil_score' loan.id %}" 
                  class="btn btn-generate mt-2">
            ‚ö° Generate CIBIL
          </button>
        {% else %}
          <span class="text-muted">Not generated yet</span>
        {% endif %}
      {% endif %}
    </div>
  </div>

  <!-- ‚úÖ Job Information -->
  <div class="card">
    <h4>Job Information</h4>
    <p><strong>Company Name:</strong> **********</p>
    <p><strong>Company Type:</strong> {{ applicant_details.company_type|default:"N/A" }}</p>
    <p><strong>Designation:</strong> {{ applicant_details.designation|default:"N/A" }}</p>
    <p><strong>ITR:</strong> {{ applicant_details.itr|default:"N/A" }}</p>
    <p><strong>Current Salary:</strong> ‚Çπ{{ applicant_details.current_salary|default:"0" }}</p>
    <p><strong>Other Income:</strong> ‚Çπ{{ applicant_details.other_income|default:"0" }}</p>
    <p><strong>Total EMI:</strong> ‚Çπ{{ applicant_details.total_emi|default:"0" }}</p>
  </div>

  <!-- ‚úÖ Business Information -->
  <div class="card">
    <h4>Business Information</h4>
    <p><strong>Business Name:</strong> **********</p>
    <p><strong>Business Type:</strong> {{ applicant_details.business_type|default:"N/A" }}</p>
    <p><strong>Business Sector:</strong> {{ applicant_details.business_sector|default:"N/A" }}</p>
    <p><strong>Total Turnover:</strong> ‚Çπ{{ applicant_details.total_turnover|default:"0" }}</p>
    <p><strong>Last Year Turnover:</strong> ‚Çπ{{ applicant_details.last_year_turnover|default:"0" }}</p>
    <p><strong>Business Total EMI:</strong> ‚Çπ{{ applicant_details.business_total_emi|default:"0" }}</p>
    <p><strong>Business ITR Status:</strong> {{ applicant_details.business_itr_status|default:"N/A" }}</p>
  </div>
  {% endif %}

  <!-- ‚úÖ Loan Info -->
  <div class="card">
    <h4>Loan Details</h4>
    <table>
      <tbody>
        <tr><th>Loan ID</th><td>{{ loan.loan_id|default:"N/A" }}</td></tr>
        <tr><th>Amount Requested</th><td>‚Çπ{{ loan.amount_requested|default:"0" }}</td></tr>
        <tr><th>Reason</th><td>{{ loan.reason_for_loan|default:"N/A" }}</td></tr>
        <tr><th>Duration</th><td>{{ loan.duration_months|default:"0" }} months</td></tr>
        <tr><th>Interest Rate</th><td>{{ loan.interest_rate|default:"0" }}%</td></tr>
        <tr><th>Status</th><td>{{ loan.status|default:"N/A" }}</td></tr>
        <tr><th>Created At</th><td>{{ loan.created_at|date:"d-m-Y H:i"|default:"N/A" }}</td></tr>
      </tbody>
    </table>
  </div>

  <!-- ‚úÖ Back -->
  <div class="mt-3">
    <a href="{{ dashboard_url }}" class="btn-back">‚¨Ö Back to Dashboard</a>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function(){
  const btn = document.getElementById("generateCibilBtn");
  if(btn){
    btn.addEventListener("click", function(){
      const url = btn.dataset.url;
      btn.disabled = true;
      btn.textContent = "‚è≥ Generating...";
      
      fetch(url, {headers: {"X-Requested-With":"XMLHttpRequest"}})
        .then(res => res.json())
        .then(data => {
          let alertBox = document.getElementById("alertBox");
          alertBox.innerHTML = "";
          if(data.ok){
            alertBox.innerHTML = `
              <div class="alert alert-success alert-dismissible fade show shadow-sm mt-3">
                ‚úÖ ${data.message} (Score: <strong>${data.score}</strong>)
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
              </div>`;
            document.getElementById("cibilSection").innerHTML = `
              <input type="text" class="form-control" value="${data.score}" readonly 
                     style="max-width:220px; background:#f8f9fa;">
              <small class="text-muted d-block mt-1">
                Generated on ${new Date(data.created_at).toLocaleString()}
                <br>üîí Next generation available after: <strong>31 days</strong>
              </small>`;
          } else {
            alertBox.innerHTML = `
              <div class="alert alert-danger alert-dismissible fade show shadow-sm mt-3">
                ‚ö†Ô∏è ${data.message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
              </div>`;
            btn.disabled = false;
            btn.textContent = "‚ö° Generate CIBIL";
          }
        })
        .catch(err => {
          console.error(err);
          btn.disabled = false;
          btn.textContent = "‚ö° Generate CIBIL";
        });
    });
  }
});
</script>
{% endblock %}
