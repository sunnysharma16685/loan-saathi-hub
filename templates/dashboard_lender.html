{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Loan Saathi Hub - Lender Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { font-family: 'Poppins', sans-serif; background: #f5f8fa; }
    header, footer { background: #0d6efd; color: #fff; padding: 15px 30px; }
    header { display: flex; justify-content: space-between; align-items: center; }
    header a { color: #fff; text-decoration: none; margin-left: 15px; font-weight: 600; }
    h1 { margin: 25px 30px; font-size: 26px; font-weight: 600; color: #333; }
    table { width: 95%; margin: 20px auto; border-collapse: collapse; background: #fff;
            border-radius: 8px; overflow: hidden; box-shadow: 0px 3px 10px rgba(0,0,0,0.08); }
    table th, table td { border: 1px solid #eee; padding: 12px; text-align: center; font-size: 14px; }
    table th { background: #0d6efd; color: #fff; font-weight: 600; }
    .btn { padding: 6px 14px; border-radius: 5px; font-size: 13px; }
    .btn-view { background: #0d6efd; color: #fff; }
    .btn-approve { background: #28a745; color: #fff; }
    .btn-reject { background: #dc3545; color: #fff; }
    .btn-warning { color: #000; background: #ffc107; }
    footer { text-align: center; font-size: 14px; margin-top: 40px; }
    footer a { color: #fff; margin: 0 5px; text-decoration: none; }
  </style>
</head>
<body>

<header>
  <div><strong>Loan Saathi Hub</strong></div>
  <div>
    <span>Welcome, {{ request.user.full_name|default:request.user.email|title }}</span>
    <a href="{% url 'home' %}">Home</a>
    <a href="{% url 'logout' %}">Logout</a>
    <a href="{% url 'edit_profile' request.user.id %}" class="btn btn-warning">Edit Profile</a>
  </div>
</header>

<h1>Lender Dashboard</h1>
<div class="row mb-3">
  <div class="col-md-3">
    <div class="card text-center bg-primary text-white filter-box" data-filter="today">
      <div class="card-body">
        <h5>Total Loan - Today</h5>
        <h3>{{ total_today }}</h3>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-center bg-success text-white filter-box" data-filter="approved">
      <div class="card-body">
        <h5>Total Approved</h5>
        <h3>{{ total_approved }}</h3>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-center bg-danger text-white filter-box" data-filter="rejected">
      <div class="card-body">
        <h5>Total Rejected</h5>
        <h3>{{ total_rejected }}</h3>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-center bg-warning text-dark filter-box" data-filter="pending">
      <div class="card-body">
        <h5>Total Pending</h5>
        <h3>{{ total_pending }}</h3>
      </div>
    </div>
  </div>
</div>

<table>
  <thead>
    <tr>
      <th>Sl No.</th>
      <th>Created Date</th>
      <th>Loan ID</th>
      <th>Applicant</th>
      <th>Loan Type</th>
      <th>Amount</th>
      <th>Duration</th>
      <th>ROI</th>
      <th>Status</th>
      <th>Remarks</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    {% for fb in lender_feedbacks %}
      <tr class="{% if fb.status == 'Rejected' %}table-danger{% elif fb.status == 'Approved' %}table-success{% endif %}">
        <td>{{ forloop.counter }}</td>
        <td>{{ fb.loan.created_at|date:"d-m-Y" }}</td>
        <td>{{ fb.loan_id }}</td>
        <td>{{ fb.loan.applicant.full_name|default:fb.loan.applicant.email }}</td>
        <td>{{ fb.loan.loan_type }}</td>
        <td>₹{{ fb.loan.amount }}</td>
        <td>{{ fb.loan.duration_months }} months</td>
        <td>{{ fb.loan.interest_rate }}%</td>
        <td>{{ fb.status }}</td>
        <td>{{ fb.remark|default:"No remark" }}</td>
        <td>
          <!-- Always show Partial Profile -->
          {% if fb.status == "Approved" %}
            <span class="btn btn-view disabled" style="opacity:0.5; pointer-events:none;">View Partial Profile</span>
          {% else %}
            <a href="{% url 'partial_profile' fb.loan.id %}" class="btn btn-view">View Partial Profile</a>
          {% endif %}

          {% if fb.status == "Pending" %}
            <a href="{% url 'make_dummy_payment' fb.loan.id %}" class="btn btn-approve">Make Dummy Payment</a>
            <button class="btn btn-reject" data-bs-toggle="modal" data-bs-target="#rejectModal{{fb.loan.id}}">Reject</button>

          {% elif fb.status == "Approved" %}
            <a href="{% url 'view_profile' fb.loan.applicant.id fb.loan.id %}" class="btn btn-view">View Full Profile</a>

          {% elif fb.status == "Rejected" %}
            <span class="text-danger">Rejected</span>
          {% endif %}
        </td>
      </tr>

      <!-- Reject Modal -->
      <div class="modal fade" id="rejectModal{{fb.loan.id}}" tabindex="-1">
        <div class="modal-dialog">
          <div class="modal-content">
            <form method="post" action="{% url 'reject_loan' fb.loan.id %}">
              {% csrf_token %}
              <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Reject Loan Request</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <label><strong>Select Reason</strong></label>
                <select name="reason" class="form-control" required>
                  <option value="">-- Select Reason --</option>
                  <option value="Low Credit Score">Low Credit Score</option>
                  <option value="Profile not match">Profile not match</option>
                  <option value="Employment Issue">Employment Issue</option>
                  <option value="Insufficient Income">Insufficient Income</option>
                  <option value="Other">Other</option>
                </select>
              </div>
              <div class="modal-footer">
                <button type="submit" class="btn btn-danger">Confirm Reject</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    {% empty %}
      <tr>
        <td colspan="10" class="text-center">No loan requests assigned yet.</td>
        <tr onclick="window.location='/loan/{{ loan.loan_id }}'" style="cursor:pointer;">
      </tr>
    {% endfor %}
  </tbody>
</table>

<footer>
  © 2025 LoanSaathiHub. All rights reserved. |
  <a href="#">About us</a> |
  <a href="#">Terms & Conditions</a> |
  <a href="#">Privacy Policy</a> |
  <a href="#">FAQ</a> |
  <a href="#">Support</a>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js">
const boxes = document.querySelectorAll('.filter-box');

boxes.forEach(box => {
    box.addEventListener('click', () => {
        const filter = box.dataset.filter;
        const today = new Date().toLocaleDateString('en-GB');

        document.querySelectorAll('#loan-table tbody tr').forEach(row => {
            const status = row.querySelector('td:nth-child(5)').innerText.toLowerCase();
            const created = row.querySelector('td:nth-child(6)').innerText;

            if(filter === 'today') {
                row.style.display = created === today ? '' : 'none';
            } else {
                row.style.display = status === filter ? '' : 'none';
            }
        });
    });
});
</script>
</body>
</html>
