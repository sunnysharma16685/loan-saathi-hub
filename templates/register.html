{% extends "base.html" %}
{% load static %}

{% block title %}Register — Loan Saathi Hub{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-md-7 col-lg-6">
    <div class="card shadow-lg border-0 rounded-4 p-4">
      <!-- Header -->
      <div class="text-center mb-4">
        <div class="rounded-circle bg-light d-inline-flex align-items-center justify-content-center mb-3"
             style="width:60px;height:60px;">
          <i class="bi bi-person-plus text-success fs-3"></i>
        </div>
        <h3 class="fw-bold mb-1">Create Your Account</h3>
        <p class="text-muted mb-0">Register as an applicant or lender to get started</p>
      </div>

      <!-- Form -->
      <form method="POST" id="registerForm" novalidate>
        {% csrf_token %}
        <div class="row g-3">
          <!-- Role -->
          <div class="col-md-6">
            <label class="form-label fw-semibold">Register as</label>
            <select name="role" id="role" class="form-select" required>
              <option value="">-- Select Role --</option>
              <option value="applicant" {% if role == "applicant" %}selected{% endif %}>Applicant</option>
              <option value="lender" {% if role == "lender" %}selected{% endif %}>Lender</option>
            </select>
          </div>

          <!-- Email -->
          <div class="col-md-6">
            <label class="form-label fw-semibold">Email</label>
            <input type="email" name="email" id="email" class="form-control" 
                   value="{{ request.POST.email|default:'' }}" required>
          </div>

          <!-- Password -->
          <div class="col-md-6">
            <label class="form-label fw-semibold">Password</label>
            <div class="input-group">
              <input type="password" name="password" id="password" class="form-control" 
                     required minlength="8" aria-describedby="passwordHelp">
              <button type="button" class="btn btn-outline-secondary" id="togglePassword">
                <i class="bi bi-eye"></i>
              </button>
            </div>
            <div id="passwordHelp" class="form-text">At least 8 characters recommended</div>
          </div>

          <!-- Confirm Password -->
          <div class="col-md-6">
            <label class="form-label fw-semibold">Confirm Password</label>
            <div class="input-group">
              <input type="password" name="confirm_password" id="confirm_password" class="form-control" required>
              <button type="button" class="btn btn-outline-secondary" id="toggleConfirmPassword">
                <i class="bi bi-eye"></i>
              </button>
            </div>
          </div>
        </div>

        <!-- Terms -->
        <div class="form-check mt-3">
          <input class="form-check-input" type="checkbox" id="terms" name="terms" required>
          <label class="form-check-label" for="terms">
            I agree to the <a href="{% url 'terms' %}" target="_blank" rel="noopener">Terms & Conditions</a>
          </label>
        </div>

        <!-- Submit -->
        <div class="d-grid mt-4">
          <button class="btn btn-success btn-lg rounded-3 shadow-sm" type="submit">
            <i class="bi bi-person-check me-1"></i> Create Account
          </button>
        </div>

        <!-- Login Link -->
        <div class="text-center mt-3 small">
          <span class="text-muted">Already have an account?</span> 
          <a href="{% url 'login' %}" class="fw-semibold text-decoration-none">Login here</a>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const form = document.getElementById("registerForm");

  if (form) {
    form.addEventListener("submit", async function(e) {
      e.preventDefault();

      const pass = document.getElementById("password").value;
      const confirm = document.getElementById("confirm_password").value;
      if (pass !== confirm) {
        Swal.fire("Error", "❌ Passwords do not match.", "error");
        return;
      }

      try {
        const res = await fetch(form.action || window.location.pathname, {
          method: "POST",
          body: new FormData(form),
          headers: { "X-Requested-With": "XMLHttpRequest" }
        });
        const data = await res.json();

        if (data.ok && data.show_otp) {
          let timerInterval;
          Swal.fire({
            title: "Enter OTP",
            html: `
              <p>OTP sent to your email</p>
              <input type="text" id="otpInput" class="swal2-input" placeholder="Enter 6-digit OTP">
              <p id="timerText" class="mt-2 text-danger fw-bold"></p>
              <button id="resendBtn" class="btn btn-link mt-2" style="display:none;">Resend OTP</button>
            `,
            confirmButtonText: "Verify",
            allowOutsideClick: false,
            didOpen: () => {
              const resendBtn = Swal.getPopup().querySelector("#resendBtn");
              const timerText = Swal.getPopup().querySelector("#timerText");

              let timeLeft = 300; // 5 minutes
              timerInterval = setInterval(() => {
                const min = Math.floor(timeLeft / 60);
                const sec = timeLeft % 60;
                timerText.textContent = `Time left: ${min}:${sec < 10 ? "0"+sec : sec}`;
                timeLeft--;
                if (timeLeft < 0) {
                  clearInterval(timerInterval);
                  timerText.textContent = "OTP expired!";
                  resendBtn.style.display = "block";
                }
              }, 1000);

              // ✅ Resend OTP
              resendBtn.addEventListener("click", async () => {
                try {
                  const res = await fetch("/resend-email-otp/");
                  const data = await res.json();
                  if (data.ok) {
                    Swal.fire("✅ Sent", data.msg, "success").then(() => location.reload());
                  } else {
                    Swal.fire("Error", data.msg, "error");
                  }
                } catch {
                  Swal.fire("Error", "Failed to resend OTP", "error");
                }
              });
            },
            preConfirm: async () => {
              const otp = Swal.getPopup().querySelector("#otpInput").value;
              if (!otp) {
                Swal.showValidationMessage("⚠ Please enter OTP");
                return false;
              }
              const verifyRes = await fetch(`/verify-email-otp/?otp=${otp}`);
              const verifyData = await verifyRes.json();
              if (!verifyData.ok) {
                Swal.showValidationMessage("❌ " + (verifyData.msg || "Invalid OTP"));
                return false;
              }
              return verifyData;
            }
          }).then((result) => {
            if (result.isConfirmed && result.value.redirect_url) {
              window.location.href = result.value.redirect_url;
            }
          });
        } else {
          Swal.fire("Error", data.msg || "Registration failed", "error");
        }
      } catch (err) {
        console.error("Register error:", err);
        Swal.fire("Error", "Server error. Please try again.", "error");
      }
    });
  }

  // ✅ Toggle password visibility helper
  function toggleVisibility(btnId, inputId) {
    const btn = document.getElementById(btnId);
    const input = document.getElementById(inputId);
    if (!btn || !input) return;
    btn.addEventListener("click", () => {
      const icon = btn.querySelector("i");
      if (input.type === "password") {
        input.type = "text";
        icon.classList.replace("bi-eye", "bi-eye-slash");
      } else {
        input.type = "password";
        icon.classList.replace("bi-eye-slash", "bi-eye");
      }
    });
  }
  toggleVisibility("togglePassword", "password");
  toggleVisibility("toggleConfirmPassword", "confirm_password");
});
</script>
{% endblock %}
