{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Dashboard | Loan Saathi Hub</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body { font-family: 'Poppins', sans-serif; background:#f8fafc; color:#212529; }

    header, footer {
      background:#0d6efd; color:#fff;
      padding:14px 20px; display:flex;
      justify-content:space-between; align-items:center;
    }
    header a, footer a { color:#fff; text-decoration:none; margin-left:14px; }
    header a:hover, footer a:hover { text-decoration:underline; }

    .container-max { max-width:1200px; margin:20px auto; }

    .card {
      border-radius:12px;
      box-shadow:0 8px 24px rgba(0,0,0,0.05);
      border:none; padding:20px;
    }

    table th { background:#0d6efd; color:#fff; font-weight:600; }
    table td { vertical-align:middle; }
    .search-input { width:250px; }

    .muted-small { font-size:13px; color:#f1f5f9; }

    .actions-btns .btn { margin-left:6px; }

    footer { font-size:14px; }
  </style>
</head>
<body>

<!-- ✅ HEADER -->
<header>
  <div><strong>Loan Saathi Hub — Admin</strong></div>
  <div>
    <span class="muted-small">Welcome, {{ request.user.full_name }}</span>
    <a href="{% url 'index' %}" class="ms-3">Home</a>
    <a href="{% url 'logout' %}" class="ms-3">Logout</a>
  </div>
</header>

<div class="container-max">
  <h2 class="my-4 fw-bold">Admin Dashboard</h2>

  <!-- USERS -->
  <div class="card mb-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 class="mb-0">Total Registered Users</h5>
      <input class="form-control form-control-sm search-input"
             placeholder="🔍 Search users by email..."
             data-target="users-table-search" />
    </div>

    <div class="table-responsive">
      <table class="table table-hover align-middle" id="users-table">
        <thead>
          <tr>
            <th>Sl No.</th>
            <th>Email</th>
            <th>Joined Date</th>
            <th>Role</th>
            <th>Profile Status</th>
            <th class="text-end">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for u in users %}
          <tr data-email="{{ u.email|lower }}" data-userid="{{ u.id }}">
            <td>{{ forloop.counter }}</td>
            <td>{{ u.email }}</td>
            <td>
              {% if u.created_at %}
                {{ u.created_at|date:"d-m-Y H:i" }}
              {% else %}
                {{ u.date_joined|date:"d-m-Y H:i" }}
              {% endif %}
            </td>
            <td>{{ u.role|default:"-"|capfirst }}</td>
            <td>
              {% if u.profile %}
                {% if not u.profile.is_reviewed and not u.profile.full_name %}
                  <span class="badge bg-dark">Incomplete</span>
                {% elif u.profile.status == "Active" %}
                  <span class="badge bg-success">Active</span>
                {% elif u.profile.status == "Hold" %}
                  <span class="badge bg-warning text-dark">Hold</span>
                {% elif u.profile.status == "Deactivated" %}
                  <span class="badge bg-secondary">Deactivated</span>
                {% elif u.profile.status == "Deleted" %}
                  <span class="badge bg-danger">Deleted</span>
                {% else %}
                  <span class="badge bg-light text-dark">Pending</span>
                {% endif %}
              {% else %}
                <span class="badge bg-light text-dark">No Profile</span>
              {% endif %}
            </td>
            <td class="text-end actions-btns">
              {% if u.profile %}
                {% if not u.profile.full_name %}
                  <button class="btn btn-sm btn-danger js-action-btn"
                          data-action="delete" data-user="{{ u.id }}">Delete</button>
                {% else %}
                  {% if u.profile.status == "Hold" %}
                    <button class="btn btn-sm btn-primary js-action-btn"
                            data-action="accept" data-user="{{ u.id }}">Accept</button>
                  {% endif %}
                  {% if u.profile.status == "Active" %}
                    <button class="btn btn-sm btn-warning js-action-btn"
                            data-action="deactivate" data-user="{{ u.id }}">Deactivate</button>
                  {% elif u.profile.status == "Deactivated" %}
                    <button class="btn btn-sm btn-success js-action-btn"
                            data-action="activate" data-user="{{ u.id }}">Activate</button>
                  {% endif %}
                  {% if u.profile.status != "Deleted" %}
                    <button class="btn btn-sm btn-danger js-action-btn"
                            data-action="delete" data-user="{{ u.id }}">Delete</button>
                  {% endif %}
                  <a href="{% url 'admin_full_profile' u.id %}"
                     class="btn btn-sm btn-info">Full Profile</a>
                {% endif %}
              {% endif %}
            </td>
          </tr>
          {% empty %}
          <tr><td colspan="6" class="text-center text-muted">No users registered.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  <!-- 2) Applicants -->
  <div class="card">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h5>Total Applicants</h5>
      <input class="form-control form-control-sm search-input"
             placeholder="Search applicants by name/email..."
             data-target="applicants-table-search" />
    </div>
    <div class="table-responsive">
      <table class="table" id="applicants-table">
        <thead>
          <tr>
            <th>Sl No.</th>
            <th>User ID</th>
            <th>Name</th>
            <th>Email</th>
            <th>Mobile</th>
            <th>Profile Status</th>
            <th style="text-align:right">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for a in applicants %}
          <tr data-search="{{ a.user.email|lower }} {{ a.user.profile.full_name|default:''|lower }}"
              data-userid="{{ a.user.id }}">
            <td>{{ forloop.counter }}</td>
            <td>{{ a.user.user_id }}</td>
            <td>{{ a.user.profile.full_name|default:"N/A" }}</td>
            <td>{{ a.user.email }}</td>
            <td>{{ a.user.profile.mobile|default:"N/A" }}</td>
            <td>
              {% if a.user.profile %}
                {% if a.user.profile.status == "Active" %}
                  <span class="badge bg-success">Active</span>
                {% elif a.user.profile.status == "Hold" %}
                  <span class="badge bg-warning text-dark">Hold</span>
                {% elif a.user.profile.status == "Deactivated" %}
                  <span class="badge bg-secondary">Deactivated</span>
                {% elif a.user.profile.status == "Deleted" %}
                  <span class="badge bg-danger">Deleted</span>
                {% else %}
                  <span class="badge bg-light text-dark">Pending</span>
                {% endif %}
              {% endif %}
            </td>
            <td class="text-end">
              {% if a.user.profile and a.user.profile.status == "Active" %}
                <button class="btn btn-sm btn-warning js-action-btn"
                        data-action="deactivate" data-user="{{ a.user.id }}">
                  Deactivate
                </button>
              {% elif a.user.profile and a.user.profile.status == "Deactivated" %}
                <button class="btn btn-sm btn-success js-action-btn"
                        data-action="activate" data-user="{{ a.user.id }}">
                  Activate
                </button>
              {% endif %}
              {% if a.user.profile and a.user.profile.status != "Deleted" %}
                <button class="btn btn-sm btn-danger js-action-btn"
                        data-action="delete" data-user="{{ a.user.id }}">
                  Delete
                </button>
              {% endif %}
            </td>
          </tr>
          {% empty %}
          <tr><td colspan="7">No applicants found.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- 3) Lenders -->
  <div class="card">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h5>Total Lenders</h5>
      <input class="form-control form-control-sm search-input"
             placeholder="Search lenders by name/email..."
             data-target="lenders-table-search" />
    </div>
    <div class="table-responsive">
      <table class="table" id="lenders-table">
        <thead>
          <tr>
            <th>Sl No.</th>
            <th>User ID</th>
            <th>Name</th>
            <th>Email</th>
            <th>Mobile</th>
            <th>Profile Status</th>
            <th style="text-align:right">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for l in lenders %}
          <tr data-search="{{ l.user.email|lower }} {{ l.user.profile.full_name|default:''|lower }}"
              data-userid="{{ l.user.id }}">
            <td>{{ forloop.counter }}</td>
            <td>{{ l.user.user_id }}</td>
            <td>{{ l.user.profile.full_name|default:"N/A" }}</td>
            <td>{{ l.user.email }}</td>
            <td>{{ l.user.profile.mobile|default:"N/A" }}</td>
            <td>
  {% if l.user.profile %}
    {% if not l.user.profile.full_name or not l.user.profile.mobile %}
      <span class="badge bg-secondary">Incomplete</span>
    {% elif l.user.profile.status == "Active" %}
      <span class="badge bg-success">Active</span>
    {% elif l.user.profile.status == "Hold" %}
      <span class="badge bg-warning text-dark">Hold</span>
    {% elif l.user.profile.status == "Deactivated" %}
      <span class="badge bg-secondary">Deactivated</span>
    {% elif l.user.profile.status == "Deleted" %}
      <span class="badge bg-danger">Deleted</span>
    {% else %}
      <span class="badge bg-light text-dark">Pending</span>
    {% endif %}
  {% else %}
    <span class="badge bg-light text-dark">No Profile</span>
  {% endif %}
</td>

<td class="text-end">
  {% if l.user.profile %}
    {% if not l.user.profile.full_name or not l.user.profile.mobile %}
      <!-- ✅ Incomplete profile → sirf Delete -->
      <button class="btn btn-sm btn-danger js-action-btn"
              data-action="delete" data-user="{{ l.user.id }}">
        Delete
      </button>
    {% else %}
      <!-- ✅ Normal active/deactivated users -->
      {% if l.user.profile.status == "Active" %}
        <button class="btn btn-sm btn-warning js-action-btn"
                data-action="deactivate" data-user="{{ l.user.id }}">
          Deactivate
        </button>
      {% elif l.user.profile.status == "Deactivated" %}
        <button class="btn btn-sm btn-success js-action-btn"
                data-action="activate" data-user="{{ l.user.id }}">
          Activate
        </button>
      {% endif %}
      {% if l.user.profile.status != "Deleted" %}
        <button class="btn btn-sm btn-danger js-action-btn"
                data-action="delete" data-user="{{ l.user.id }}">
          Delete
        </button>
      {% endif %}
    {% endif %}
  {% endif %}
</td>

          </tr>
          {% empty %}
          <tr><td colspan="7">No lenders found.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- 4) Loan Requests -->
  <div class="card">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h5>Total Loan Requests</h5>
      <input class="form-control form-control-sm search-input"
             placeholder="Search loans by ID/type..."
             data-target="loans-table-search" />
    </div>
    <div class="table-responsive">
      <table class="table" id="loans-table">
        <thead>
          <tr>
            <th>Sl No.</th>
            <th>Loan ID</th>
            <th>Type</th>
            <th>Amount</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          {% for loan in loans %}
          <tr data-search="{{ loan.loan_id|lower }} {{ loan.loan_type|lower }}">
            <td>{{ forloop.counter }}</td>
            <td>{{ loan.loan_id }}</td>
            <td>{{ loan.loan_type }}</td>
            <td>₹{{ loan.amount_requested }}</td>
            <td>
              <span class="badge 
                {% if loan.status == 'Approved' %}bg-success
                {% elif loan.status == 'Rejected' %}bg-danger
                {% elif loan.status == 'Pending' %}bg-secondary
                {% else %}bg-warning text-dark{% endif %}">
                {{ loan.status }}
              </span>
            </td>
          </tr>
          {% empty %}
          <tr><td colspan="5">No loan requests found.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  <!-- 5) Payments -->
  <div class="card">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h5>Total Payments</h5>
      <input class="form-control form-control-sm search-input"
             placeholder="Search payments by loan id or lender..."
             data-target="payments-table-search" />
    </div>
    <div class="table-responsive">
      <table class="table" id="payments-table">
        <thead>
          <tr>
            <th>Sl No.</th>
            <th>Loan ID</th>
            <th>Transaction ID</th>
            <th>Lender Name</th>
            <th>Lender Email</th>
            <th>Lender Mobile</th>
            <th>Payment Amount</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          {% for p in payments %}
          <tr data-search="{{ p.loan_request.loan_id|lower }} {{ p.lender.email|lower }} {{ p.lender.profile.full_name|default:''|lower }}">
            <td>{{ forloop.counter }}</td>
            <td>{{ p.loan_request.loan_id }}</td>
            <td>{{ p.id }}</td>
            <td>{{ p.lender.profile.full_name|default:"N/A" }}</td>
            <td>{{ p.lender.email }}</td>
            <td>{{ p.lender.profile.mobile|default:"N/A" }}</td>
            <td>₹{{ p.amount }}</td>
            <td>
              <span class="badge 
                {% if p.status == 'Completed' %}bg-success
                {% elif p.status == 'Pending' %}bg-secondary
                {% else %}bg-warning text-dark{% endif %}">
                {{ p.status }}
              </span>
            </td>
          </tr>
          {% empty %}
          <tr><td colspan="8">No payments found.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- ✅ MODAL -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered">
    <div class="modal-content">
      <form id="adminActionForm" method="post" action="">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="confirmTitle">Confirm Action</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="confirmBody"></div>
        <div class="modal-footer">
          <input type="hidden" name="action" id="modalActionInput" value="">
          <input type="hidden" name="reason" id="modalReasonInput" value="">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn" id="confirmSubmitBtn">Confirm</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- ✅ FOOTER -->
<footer class="mt-5">
  <div class="container-max d-flex flex-wrap justify-content-between py-3">
    <div>© 2025 Loan Saathi Hub</div>
    <div>
      <a href="{% url 'about' %}">About</a> |
      <a href="{% url 'terms' %}">Terms</a> |
      <a href="{% url 'privacy' %}">Privacy</a> |
      <a href="{% url 'faq' %}">FAQ</a> |
      <a href="{% url 'support' %}">Support</a>
    </div>
  </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function(){
  // ✅ Search filter
  document.querySelectorAll('.search-input').forEach(function(el){
    el.addEventListener('input', function(){
      var targetKey = el.dataset.target;
      var map = {
        'users-table-search': 'users-table',
        'applicants-table-search': 'applicants-table',
        'lenders-table-search': 'lenders-table',
        'loans-table-search': 'loans-table',
        'payments-table-search': 'payments-table'
      };
      var tableId = map[targetKey];
      if(!tableId) return;
      var q = el.value.trim().toLowerCase();
      var tbody = document.querySelector('#' + tableId + ' tbody');
      if(!tbody) return;
      Array.from(tbody.rows).forEach(function(row){
        var text = (row.dataset.search || row.dataset.email || '').toLowerCase();
        row.style.display = (q === '' || text.indexOf(q) !== -1) ? '' : 'none';
      });
    });
  });

  // ✅ Modal confirm
  var actionButtons = document.querySelectorAll('.js-action-btn');
  var confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
  var form = document.getElementById('adminActionForm');
  var modalTitle = document.getElementById('confirmTitle');
  var modalBody = document.getElementById('confirmBody');
  var modalAction = document.getElementById('modalActionInput');

  actionButtons.forEach(function(btn){
    btn.addEventListener('click', function(){
      var action = btn.dataset.action;
      var userId = btn.dataset.user;
      var emailCell = btn.closest('tr').querySelector('td:nth-child(2)');
      var email = emailCell ? emailCell.innerText.trim() : '';

      form.action = "/admin/user_action/" + userId + "/";
      modalAction.value = action;

      if(action === 'deactivate'){
        modalTitle.innerText = "Deactivate Account?";
        modalBody.innerHTML = "<p>Deactivate account <strong>" + email + "</strong>.</p>"
          + "<p class='text-danger small'>Reason (optional):</p>"
          + "<textarea id='modalReasonInputField' name='reason' class='form-control' rows='3'></textarea>";
        document.getElementById('confirmSubmitBtn').className = "btn btn-warning";
      } else if(action === 'activate'){
        modalTitle.innerText = "Activate Account?";
        modalBody.innerHTML = "<p>Activate account <strong>" + email + "</strong>.</p>";
        document.getElementById('confirmSubmitBtn').className = "btn btn-success";
      } else if(action === 'delete'){
        modalTitle.innerText = "Delete Account?";
        modalBody.innerHTML = "<p class='text-danger'>Permanently disable <strong>" + email + "</strong>.</p>";
        document.getElementById('confirmSubmitBtn').className = "btn btn-danger";
      } else if(action === 'accept'){
        modalTitle.innerText = "Accept Profile?";
        modalBody.innerHTML = "<p>Approve profile for <strong>" + email + "</strong>.</p>";
        document.getElementById('confirmSubmitBtn').className = "btn btn-primary";
      } else {
        modalTitle.innerText = "Confirm";
        modalBody.innerText = "Proceed?";
      }

      confirmModal.show();
    });
  });
});
</script>
</body>
</html>