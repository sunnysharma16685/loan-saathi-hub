{% extends "base.html" %}
{% load static %}

{% block title %}Lender Dashboard ‚Äî Loan Saathi Hub{% endblock %}

{% block extra_head %}
<style>
  h1 {
    margin: 20px;
    font-size: 28px;
    text-align: center;
    font-weight: 700;
    color: #0f172a;
  }

  /* ‚úÖ Buttons */
  .btn {
    border-radius: 8px;
    font-weight: 600;
    padding: 8px 14px;
    transition: all 0.25s ease;
  }
  .btn-approve { background:#22c55e; color:#fff; border:none; }
  .btn-approve:hover { background:#16a34a; color:#fff; }
  .btn-reject { background:#ef4444; color:#fff; border:none; }
  .btn-reject:hover { background:#dc2626; color:#fff; }
  .btn-view { background:#0ea5e9; color:#0f172a; border:none; }
  .btn-view:hover { background:#38bdf8; color:#0f172a; }
  .btn-warning { background:#fbbf24; color:#1f2937; border:none; }
  .btn-warning:hover { background:#f59e0b; color:#111827; }

  /* ‚úÖ Top-right actions */
  .top-actions {
    display:flex;
    justify-content:flex-end;
    gap:.75rem;
    margin-bottom:1rem;
  }

  /* ‚úÖ Cards */
  .card {
    border-radius: 14px;
    box-shadow: 0 10px 25px rgba(15,23,42,0.08);
    border: none;
    overflow: hidden;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }
  .card:hover {
    transform: translateY(-2px);
    box-shadow: 0 14px 32px rgba(15,23,42,0.12);
  }
  .card .card-body h5 {
    font-weight: 600;
    letter-spacing: .01em;
  }
  .card .card-body h3 {
    font-weight: 800;
    margin: 0;
  }

  .card.bg-primary {
    background: linear-gradient(135deg, #0ea5e9, #0f766e);
  }
  .card.bg-success {
    background: linear-gradient(135deg, #22c55e, #15803d);
  }
  .card.bg-danger {
    background: linear-gradient(135deg, #ef4444, #b91c1c);
  }
  .card.bg-warning {
    background: linear-gradient(135deg, #f97316, #facc15);
  }

  .filter-box { cursor:pointer; }

  /* ‚úÖ Table */
  .table-wrapper {
    width:100%;
    overflow-x:auto;
    margin-top: 10px;
  }

  table {
    width:100%;
    margin:0 auto 20px;
    border-collapse:collapse;
    background:#fff;
    border-radius:12px;
    overflow:hidden;
    box-shadow:0 10px 28px rgba(15,23,42,0.08);
  }
  th, td {
    padding:12px 10px;
    text-align:center;
    vertical-align:middle;
    white-space:nowrap;
  }
  thead th {
    background:#0f766e;
    color:#f9fafb;
    font-weight:600;
    font-size:0.9rem;
  }
  tbody tr:nth-child(even) { background:#f9fafb; }
  tbody tr:hover { background:#e5f3ff; transition:.2s; }

  .badge {
    font-size: .8rem;
    font-weight: 600;
    padding: .4rem .6rem;
    border-radius: 999px;
  }

  /* ‚úÖ Small legend */
  .status-legend {
    font-size: 0.85rem;
    color: #64748b;
    margin: 0 0 8px 4px;
  }
  .status-legend span {
    margin-right: 10px;
  }

  /* ‚úÖ Modal tweaks */
  .modal-header.bg-danger,
  .modal-header.bg-info {
    border-bottom: none;
  }
  .modal-content {
    border-radius: 14px;
    box-shadow: 0 14px 40px rgba(15,23,42,0.25);
  }

  @media (max-width: 768px) {
    h1 {
      font-size: 22px;
      margin-top: 10px;
    }
    .top-actions {
      flex-direction:column;
      align-items:flex-end;
    }
    th, td {
      font-size:0.78rem;
      padding:8px 6px;
    }
  }
</style>
{% endblock %}

{% block content %}
<h1>Lender Dashboard</h1>

<!-- ‚úÖ Django Messages -->
{% if messages %}
  {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show shadow-sm">
      {{ message }}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  {% endfor %}
{% endif %}

<!-- ‚úÖ Top Actions -->
<div class="top-actions">
  <a href="{% url 'dashboard_lender' %}" class="btn btn-outline-secondary">All Loans</a>
  <a href="{% url 'edit_profile' request.user.id %}" class="btn btn-warning">Edit Profile</a>
</div>

<!-- ‚úÖ Stats Cards Row -->
<div class="row mb-3 px-1 g-3">
  <div class="col-md-3 col-6">
    <div class="card text-center text-white filter-box" data-filter="today">
      <div class="card-body py-3">
        <h5 class="mb-1">Loan Requests Today</h5>
        <h3>{{ total_today }}</h3>
      </div>
    </div>
  </div>
  <div class="col-md-3 col-6">
    <div class="card text-center text-white filter-box bg-success" data-filter="approved">
      <div class="card-body py-3">
        <h5 class="mb-1">Approved</h5>
        <h3>{{ total_approved }}</h3>
      </div>
    </div>
  </div>
  <div class="col-md-3 col-6">
    <div class="card text-center text-white filter-box bg-danger" data-filter="rejected">
      <div class="card-body py-3">
        <h5 class="mb-1">Rejected</h5>
        <h3>{{ total_rejected }}</h3>
      </div>
    </div>
  </div>
  <div class="col-md-3 col-6">
    <div class="card text-center text-dark filter-box bg-warning" data-filter="pending">
      <div class="card-body py-3">
        <h5 class="mb-1">Pending</h5>
        <h3>{{ total_pending }}</h3>
      </div>
    </div>
  </div>
</div>

<p class="status-legend">
  <strong>Quick Filters:</strong>
  <span>üìÖ Today</span>
  <span>‚úÖ Approved</span>
  <span>‚è≥ Pending</span>
  <span>‚ùå Rejected</span>
</p>

<!-- ‚úÖ Loans Table -->
<div class="table-wrapper">
  <table class="table align-middle mb-0">
    <thead>
      <tr>
        <th>#</th>
        <th>Date</th>
        <th>Loan ID</th>
        <th>Applicant</th>
        <th>Type</th>
        <th>Amount</th>
        <th>Duration</th>
        <th>ROI</th>
        <th>Status</th>
        <th>Reason</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for fb in lender_feedbacks %}
      <tr data-status="{{ fb.display_status|lower }}" data-created="{{ fb.loan.created_at|date:'Y-m-d' }}">
        <td>{{ forloop.counter }}</td>
        <td>{{ fb.loan.created_at|date:"d-m-Y" }}</td>
        <td>{{ fb.loan.loan_id }}</td>
        <td>{{ fb.loan.applicant.profile.full_name|default:fb.loan.applicant.email }}</td>
        <td>{{ fb.loan.loan_type }}</td>
        <td>‚Çπ{{ fb.loan.amount_requested }}</td>
        <td>{{ fb.loan.duration_months }} mo</td>
        <td>{{ fb.loan.interest_rate }}%</td>
        <td>
          {% if fb.display_status == "Approved" %}
            <span class="badge bg-success">Approved by You</span>
          {% elif fb.display_status == "Rejected" %}
            <span class="badge bg-danger">Rejected by You</span>
          {% elif fb.display_status == "Pending" %}
            <span class="badge bg-warning text-dark">Pending ‚Äî Review Request</span>
          {% elif fb.display_status == "Finalised" %}
            <span class="badge bg-info text-dark">Finalised by Applicant</span>
          {% elif fb.display_status == "Closed" %}
            <span class="badge bg-secondary">Closed (Other Lender Chosen)</span>
          {% endif %}
        </td>
        <td>{{ fb.loan.reason_for_loan|default:"N/A" }}</td>
        <td>
          {% if fb.display_status == "Pending" %}
            {% if fb.payment_done %}
              <a href="{% url 'invoice' %}?txn_id={{ fb.payment_txn }}"
                 class="btn btn-success btn-sm mb-1" target="_blank">
                ‚úÖ Paid
              </a>
              <a href="{% url 'view_profile' fb.loan.id %}" class="btn btn-view btn-sm mb-1">
                üë§ Full Profile
              </a>
              <button class="btn btn-reject btn-sm mb-1"
                      data-bs-toggle="modal" data-bs-target="#rejectModal{{ fb.loan.id }}">
                Reject
              </button>
            {% else %}
              <button class="btn btn-approve btn-sm mb-1 razorpay-btn" data-loan-id="{{ fb.loan.id }}">
                üí≥ Pay ‚Çπ49
              </button>
              <a href="{% url 'partial_profile' fb.loan.id %}" class="btn btn-view btn-sm mb-1">
                üëÅÔ∏è Partial
              </a>
              <button class="btn btn-reject btn-sm mb-1"
                      data-bs-toggle="modal" data-bs-target="#rejectModal{{ fb.loan.id }}">
                Reject
              </button>
            {% endif %}

          {% elif fb.display_status == "Approved" %}
            {% if fb.payment_done %}
              <a href="{% url 'invoice' %}?txn_id={{ fb.payment_txn }}"
                 class="btn btn-success btn-sm mb-1" target="_blank">
                ‚úÖ Paid
              </a>
              <a href="{% url 'view_profile' fb.loan.id %}" class="btn btn-view btn-sm mb-1">
                üë§ Full Profile
              </a>
              <button class="btn btn-reject btn-sm mb-1"
                      data-bs-toggle="modal" data-bs-target="#rejectModal{{ fb.loan.id }}">
                Reject
              </button>
            {% else %}
              <button class="btn btn-approve btn-sm mb-1 razorpay-btn" data-loan-id="{{ fb.loan.id }}">
                üí≥ Pay ‚Çπ49
              </button>
            {% endif %}

          {% elif fb.display_status == "Finalised" %}
            <p class="text-success fw-bold mb-1">üéâ Applicant chose you!</p>
            <a href="{% url 'view_profile' fb.loan.id %}" class="btn btn-view btn-sm">
              üë§ Full Profile
            </a>

          {% elif fb.display_status == "Closed" %}
            <p class="text-muted fw-bold mb-1">‚ùå Applicant chose another lender</p>
            <a href="{% url 'partial_profile' fb.loan.id %}" class="btn btn-view btn-sm">
              üëÅÔ∏è Partial
            </a>

          {% elif fb.display_status == "Rejected" %}
            <p class="text-danger fw-bold mb-1">‚ùå You Rejected This Loan</p>
          {% endif %}
        </td>
      </tr>

      <!-- ‚ùå Reject Modal -->
      <div class="modal fade" id="rejectModal{{fb.loan.id}}" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <form method="post" action="{% url 'reject_loan' fb.loan.id %}">
              {% csrf_token %}
              <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Reject Loan</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <p class="text-danger fw-semibold">
                  ‚ö† Are you sure you want to reject this loan? This action cannot be undone.
                </p>
                <div class="mb-2">
                  <label class="form-label"><strong>Reason</strong></label>
                  <select name="reason" class="form-control" required>
                    <option value="">-- Select Reason --</option>
                    <option>Low Credit Score</option>
                    <option>Profile Not Match</option>
                    <option>Employment Issue</option>
                    <option>Insufficient Income</option>
                    <option>Large Existing EMI</option>
                    <option>Other</option>
                  </select>
                </div>
              </div>
              <div class="modal-footer">
                <button type="submit" class="btn btn-reject">Confirm Reject</button>
              </div>
            </form>
          </div>
        </div>
      </div>

      {% empty %}
      <tr>
        <td colspan="11" class="text-center text-muted py-4">
          No loan requests found yet.
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function () {
  // ‚úÖ Card Filters
  const filterBoxes = document.querySelectorAll(".filter-box");
  const mainRows = document.querySelectorAll("table tbody tr[data-status]");

  function applyFilter(kind) {
    const todayISO = new Date().toISOString().split("T")[0];

    mainRows.forEach(row => {
      const status = (row.dataset.status || "").toLowerCase();
      const created = row.dataset.created;
      let show = true;

      if (kind === "today") {
        show = (created === todayISO);
      } else if (["approved","rejected","pending","finalised","closed"].includes(kind)) {
        show = (status === kind);
      }

      row.style.display = show ? "" : "none";
    });
  }

  filterBoxes.forEach(box => {
    box.addEventListener("click", () => applyFilter(box.dataset.filter));
  });

  // ‚úÖ Razorpay Payment Buttons
  document.querySelectorAll(".razorpay-btn").forEach(button => {
    button.addEventListener("click", async () => {
      try {
        const loanId = button.dataset.loanId;

        const response = await fetch("{% url 'initiate_payment' %}", {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            "X-CSRFToken": "{{ csrf_token }}"
          },
          body: new URLSearchParams({
            amount: "49",
            loan_id: loanId
          })
        });

        const data = await response.json();
        if (!data.ok) {
          alert("‚ùå Payment initiation failed. Please try again.");
          return;
        }

        const options = {
          key: data.key,
          amount: data.amount,
          currency: data.currency,
          name: "Loan Saathi Hub",
          description: "Lender Access Fee",
          order_id: data.order_id,
          handler: function (response) {
            response.loan_id = loanId;

            fetch("{% url 'payment_callback' %}", {
              method: "POST",
              headers: {
                "Content-Type": "application/x-www-form-urlencoded"
              },
              body: new URLSearchParams(response)
            }).then(() => {
              window.location.href = "/payment/success/?txn_id=" + data.order_id;
            });
          },
          prefill: {
            name: "{{ request.user.profile.full_name|default:request.user.email }}",
            email: "{{ request.user.email }}",
            contact: "{{ request.user.profile.mobile|default:'9999999999' }}"
          },
          theme: { color: "#0f766e" }
        };

        const rzp = new Razorpay(options);
        rzp.open();
      } catch (err) {
        console.error(err);
        alert("‚ö†Ô∏è Payment initiation error. Please try again.");
      }
    });
  });
});
</script>
{% endblock %}
