{% extends "base.html" %}
{% load static %}

{% block title %}Partial Profile | Loan Saathi Hub{% endblock %}

{% block extra_head %}
<style>
  body { background:#f6f8fb; font-family:'Poppins',sans-serif; }
  .profile-container { max-width: 960px; margin: 30px auto; }
  h2 { color:#001f54; font-weight:700; margin-bottom:1rem; }
  h4 { color:#003d99; font-weight:600; margin-bottom:1rem; }

  .card {
    background:#fff; padding:24px; border-radius:14px;
    box-shadow:0 8px 20px rgba(0,0,0,0.08); margin-bottom:24px;
  }
  .card p { margin-bottom:8px; color:#333; }
  .card strong { color:#001f54; }

  table { width:100%; border-collapse:collapse; margin-top:10px; }
  table th, table td { border:1px solid #dee2e6; padding:10px; text-align:left; }
  table th {
    background:linear-gradient(90deg,#001f54,#003d99);
    color:#fff; font-weight:600;
  }

  .btn-generate {
    background:linear-gradient(135deg,#0d6efd,#2563eb);
    color:#fff; font-weight:600;
    padding:8px 16px; border-radius:6px; border:none;
    transition: all .3s ease;
  }
  .btn-generate:hover { opacity:0.9; }
  .btn-generate:disabled { background:#adb5bd; cursor:not-allowed; }

  .btn-history {
    background:#198754; color:#fff; font-weight:600;
    padding:8px 14px; border-radius:6px; border:none;
    margin-left:8px; transition:0.3s;
  }
  .btn-history:hover { background:#157347; }

  .btn-back {
    background:#001f54; color:#fff; font-weight:600;
    padding:10px 18px; border-radius:6px; text-decoration:none; transition:0.3s;
  }
  .btn-back:hover { background:#003d99; color:#fff; }

  .cibil-box { display:flex; align-items:center; gap:1rem; flex-wrap:wrap; margin-top:.5rem; }
  .cibil-score {
    font-size:1.5rem; font-weight:700;
    background:#f1f8ff; color:#0d6efd;
    padding:6px 14px; border-radius:6px;
  }

  .modal-content { border-radius:12px; box-shadow:0 8px 24px rgba(0,0,0,0.2); }
  .modal-header {
    background:linear-gradient(135deg,#001f54,#003d99);
    color:#fff; border-top-left-radius:12px; border-top-right-radius:12px;
  }
  .modal-title { font-weight:600; }

  table th { text-align:center; }
  table td { text-align:center; }

  .alert { border-radius:10px; }
</style>
{% endblock %}

{% block content %}
<div class="profile-container">
  <h2><i class="bi bi-person-badge me-2"></i> Partial Profile (Limited Access)</h2>

  <div id="alertBox"></div>

  <!-- ‚úÖ Basic Info -->
  <div class="card">
    <h4><i class="bi bi-person-circle me-2"></i> Basic Information</h4>
    <p><strong>Full Name:</strong> {{ profile.full_name|default:"N/A" }}</p>
    <p><strong>Email:</strong> **********</p>
    <p><strong>Mobile:</strong> **********</p>
    <p><strong>Gender:</strong> {{ profile.gender|default:"N/A" }}</p>
    <p><strong>Marital Status:</strong> {{ profile.marital_status|default:"N/A" }}</p>
    <p><strong>Address:</strong> **********, {{ profile.city|default:"" }}, {{ profile.state|default:"" }} - {{ profile.pincode|default:"N/A" }}</p>
    <p><strong>PAN:</strong> {{ profile.pancard_number|default:"N/A" }}</p>
    <p><strong>Aadhaar:</strong> **********</p>
    <p><strong>Date of Birth:</strong> {{ profile.dob|date:"d-m-Y"|default:"N/A" }}</p>
  </div>

  {% if applicant_details %}
  <div class="card">
    <h4><i class="bi bi-person-lines-fill me-2"></i> Applicant Details</h4>
    <p><strong>Employment Type:</strong> {{ applicant_details.employment_type|default:"N/A" }}</p>

<!-- ‚úÖ CIBIL Section -->
<p><strong>CIBIL Score:</strong></p>
<div id="cibilSection" class="cibil-box">
  {% if applicant_details.cibil_score %}
    <div>
      <span class="cibil-score">{{ applicant_details.cibil_score }}</span>
      <small class="text-muted d-block mt-1">
        Generated on {{ applicant_details.cibil_last_generated|date:"d/m/Y h:i A"|default:"N/A" }}
      </small>
    </div>

    {% if request.user.role == "lender" %}
      <button id="viewHistoryBtn" class="btn-history">
        üìú View CIBIL History
      </button>
    {% endif %}
  
  {% else %}
    {% if request.user.role == "lender" %}
      <button id="generateCibilBtn"
              data-url="{% url 'generate_cibil_score' loan.id %}"
              class="btn btn-generate mt-2">
        ‚ö° Generate Dummy CIBIL
      </button>
    {% else %}
      <span class="text-muted">Not generated yet</span>
    {% endif %}
  {% endif %}
</div>
.985369
  </div>

  <!-- ‚úÖ Job Information -->
  <div class="card">
    <h4><i class="bi bi-building-check me-2"></i> Job Information</h4>
    <p><strong>Company Name:</strong> **********</p>
    <p><strong>Company Type:</strong> {{ applicant_details.company_type|default:"N/A" }}</p>
    <p><strong>Designation:</strong> {{ applicant_details.designation|default:"N/A" }}</p>
    <p><strong>ITR:</strong> {{ applicant_details.itr|default:"N/A" }}</p>
    <p><strong>Current Salary:</strong> ‚Çπ{{ applicant_details.current_salary|default:"0" }}</p>
    <p><strong>Other Income:</strong> ‚Çπ{{ applicant_details.other_income|default:"0" }}</p>
    <p><strong>Total EMI:</strong> ‚Çπ{{ applicant_details.total_emi|default:"0" }}</p>
  </div>

  <div class="card">
    <h4><i class="bi bi-briefcase me-2"></i> Business Information</h4>
    <p><strong>Business Name:</strong> **********</p>
    <p><strong>Business Type:</strong> {{ applicant_details.business_type|default:"N/A" }}</p>
    <p><strong>Business Sector:</strong> {{ applicant_details.business_sector|default:"N/A" }}</p>
    <p><strong>Total Turnover:</strong> ‚Çπ{{ applicant_details.total_turnover|default:"0" }}</p>
    <p><strong>Last Year Turnover:</strong> ‚Çπ{{ applicant_details.last_year_turnover|default:"0" }}</p>
    <p><strong>Business Total EMI:</strong> ‚Çπ{{ applicant_details.business_total_emi|default:"0" }}</p>
    <p><strong>Business ITR Status:</strong> {{ applicant_details.business_itr_status|default:"N/A" }}</p>
  </div>
  {% endif %}

  <!-- ‚úÖ Loan Info -->
  <div class="card">
    <h4><i class="bi bi-cash-coin me-2"></i> Loan Details</h4>
    <table>
      <tbody>
        <tr><th>Loan ID</th><td>{{ loan.loan_id|default:"N/A" }}</td></tr>
        <tr><th>Amount Requested</th><td>‚Çπ{{ loan.amount_requested|default:"0" }}</td></tr>
        <tr><th>Reason</th><td>{{ loan.reason_for_loan|default:"N/A" }}</td></tr>
        <tr><th>Duration</th><td>{{ loan.duration_months|default:"0" }} months</td></tr>
        <tr><th>Interest Rate</th><td>{{ loan.interest_rate|default:"0" }}%</td></tr>
        <tr><th>Status</th><td>{{ loan.status|default:"N/A" }}</td></tr>
        <tr><th>Created At</th><td>{{ loan.created_at|date:"d-m-Y H:i"|default:"N/A" }}</td></tr>
      </tbody>
    </table>
  </div>

  <div class="mt-4 text-center">
    <a href="{{ dashboard_url }}" class="btn-back">‚¨Ö Back to Dashboard</a>
  </div>
</div>

<!-- ‚úÖ CIBIL History Modal -->
<div class="modal fade" id="cibilHistoryModal" tabindex="-1" aria-labelledby="cibilHistoryModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-clock-history me-2"></i> CIBIL History</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        {% if cibil_history %}
        <table class="table table-bordered table-striped">
          <thead>
            <tr>
              <th>#</th><th>Score</th><th>Lender</th><th>Date Generated</th>
            </tr>
          </thead>
          <tbody>
            {% for report in cibil_history %}
            <tr>
              <td>{{ forloop.counter }}</td>
              <td><strong>{{ report.score }}</strong></td>
              <td>{{ report.lender.username|default:"N/A" }}</td>
              <td>{{ report.created_at|date:"d/m/Y h:i A" }}</td>
            </tr>
            {% empty %}
            <tr><td colspan="4" class="text-muted text-center">No previous records found.</td></tr>
            {% endfor %}
          </tbody>
        </table>
        {% else %}
        <p class="text-muted text-center mb-0">No previous CIBIL history found.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- ‚úÖ SweetAlert + Bootstrap Modal Integration -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
document.addEventListener("DOMContentLoaded", function(){
  const btn = document.getElementById("generateCibilBtn");
  const viewHistoryBtn = document.getElementById("viewHistoryBtn");

  // ‚úÖ Ensure absolute URL for fetch requests
  function getAbsoluteUrl(url) {
    if (!url.startsWith("/")) return "/" + url;
    return url;
  }

  // ‚úÖ Generate Dummy CIBIL
  if (btn) {
    btn.addEventListener("click", async function() {
      const url = getAbsoluteUrl(btn.dataset.url);
      btn.disabled = true;
      btn.textContent = "‚è≥ Generating...";

      try {
        const res = await fetch(url, { headers: { "X-Requested-With": "XMLHttpRequest" } });
        const data = await res.json();

        if (data.ok) {
          Swal.fire({
            title: "‚úÖ Dummy CIBIL Generated!",
            html: `
              <div style="font-size:1.1rem;">
                Your generated CIBIL score is: 
                <b style="font-size:1.4rem; color:#0d6efd;">${data.score}</b><br>
                <small class="text-muted">(This is a dummy/test score for demo use only)</small>
              </div>
            `,
            icon: "success",
            confirmButtonText: "View History"
          }).then(() => {
            // Auto-show modal with history after generation
            const modal = new bootstrap.Modal(document.getElementById("cibilHistoryModal"));
            modal.show();
          });
        } else {
          Swal.fire("‚ö†Ô∏è Warning", data.msg || "Unable to generate CIBIL.", "warning");
          btn.disabled = false;
          btn.textContent = "‚ö° Generate Dummy CIBIL";
        }
      } catch (err) {
        console.error("CIBIL generation error:", err);
        Swal.fire("Error", "Something went wrong while generating CIBIL.", "error");
        btn.disabled = false;
        btn.textContent = "‚ö° Generate Dummy CIBIL";
      }
    });
  }

 </script>
{% endblock %}
