{% extends "base.html" %}
{% load static %}

{% block title %}Lender Dashboard ‚Äî Loan Saathi Hub{% endblock %}

{% block extra_head %}
<style>
  h1 { margin:20px; font-size:28px; text-align:center; font-weight:700; color:#212529; }

  .btn { border-radius:8px; font-weight:600; padding:8px 14px; transition:.3s; }
  .btn-approve { background:#28a745; color:#fff; }
  .btn-approve:hover { background:#218838; }
  .btn-reject { background:#dc3545; color:#fff; }
  .btn-reject:hover { background:#c82333; }
  .btn-view { background:#0dcaf0; color:#212529; }
  .btn-view:hover { background:#31d2f2; }
  .btn-warning { background:#ffc107; color:#212529; }
  .btn-warning:hover { background:#e0a800; }
  .btn-paid { background:#198754; color:#fff; }
  .btn-paid:hover { background:#157347; }

  .card { border-radius:12px; box-shadow:0 8px 20px rgba(0,0,0,0.08); transition:.2s; }
  .card:hover { transform:translateY(-3px); }
  .card h5 { font-weight:600; }

  table { width:95%; margin:20px auto; border-collapse:collapse; background:#fff;
          border-radius:8px; overflow:hidden; box-shadow:0 8px 16px rgba(0,0,0,0.08); }
  th, td { padding:12px; text-align:center; vertical-align:middle; }
  th { background:#0d6efd; color:#fff; font-weight:600; }
  tbody tr:hover { background:#f1f3f5; }
  .badge { font-size:.9em; font-weight:600; }
  .filter-box { cursor:pointer; }
</style>
{% endblock %}

{% block content %}
<h1>Lender Dashboard</h1>

{% if messages %}
  {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show shadow-sm">
      {{ message }}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  {% endfor %}
{% endif %}

<div class="d-flex justify-content-end mb-3">
  <a href="{% url 'dashboard_lender' %}" class="btn btn-secondary me-2">All Loans</a>
  <a href="{% url 'edit_profile' request.user.id %}" class="btn btn-warning">Edit Profile</a>
</div>

<div class="row mb-3 px-3">
  <div class="col-md-3 mb-3">
    <div class="card text-center bg-primary text-white filter-box" data-filter="today">
      <div class="card-body"><h5>Loan Requests Today</h5><h3>{{ total_today }}</h3></div>
    </div>
  </div>
  <div class="col-md-3 mb-3">
    <div class="card text-center bg-success text-white filter-box" data-filter="approved">
      <div class="card-body"><h5>Approved</h5><h3>{{ total_approved }}</h3></div>
    </div>
  </div>
  <div class="col-md-3 mb-3">
    <div class="card text-center bg-danger text-white filter-box" data-filter="rejected">
      <div class="card-body"><h5>Rejected</h5><h3>{{ total_rejected }}</h3></div>
    </div>
  </div>
  <div class="col-md-3 mb-3">
    <div class="card text-center bg-warning text-dark filter-box" data-filter="pending">
      <div class="card-body"><h5>Pending</h5><h3>{{ total_pending }}</h3></div>
    </div>
  </div>
</div>

<table class="table">
  <thead>
    <tr>
      <th>#</th><th>Date</th><th>Loan ID</th><th>Applicant</th>
      <th>Type</th><th>Amount</th><th>Duration</th><th>ROI</th>
      <th>Status</th><th>Reason</th><th>Actions</th>
    </tr>
  </thead>
  <tbody>
    {% for fb in lender_feedbacks %}
    <tr data-status="{{ fb.loan.global_status|lower }}" data-created="{{ fb.loan.created_at|date:'Y-m-d' }}">
      <td>{{ forloop.counter }}</td>
      <td>{{ fb.loan.created_at|date:"d-m-Y" }}</td>
      <td>{{ fb.loan.loan_id }}</td>
      <td>{{ fb.loan.applicant.profile.full_name|default:fb.loan.applicant.email }}</td>
      <td>{{ fb.loan.loan_type }}</td>
      <td>‚Çπ{{ fb.loan.amount_requested }}</td>
      <td>{{ fb.loan.duration_months }} mo</td>
      <td>{{ fb.loan.interest_rate }}%</td>
      <td>
        {% if fb.loan.status == "Accepted" and fb.loan.accepted_lender == request.user %}
          <span class="badge bg-success">Accepted by Applicant</span>
        {% elif fb.loan.status == "Accepted" %}
          <span class="badge bg-danger">Finalised by Applicant</span>
        {% elif fb.loan.global_status == "Approved" %}
          <span class="badge bg-success">Approved</span>
        {% elif fb.loan.global_status == "Rejected" %}
          <span class="badge bg-danger">Rejected</span>
        {% else %}
          <span class="badge bg-warning text-dark">Pending</span>
        {% endif %}
      </td>
      <td>{{ fb.loan.reason_for_loan|default:"N/A" }}</td>
      <td>
        {% if fb.loan.status == "Accepted" and fb.loan.accepted_lender == request.user %}
          <p class="fw-bold text-success">üéâ The Applicant chose you!</p>
          <a href="{% url 'view_profile' fb.loan.id %}" class="btn btn-view btn-sm">üë§ Full Profile</a>

        {% elif fb.loan.global_status == "Pending" %}
          {% if fb.payment_done %}
            <a href="{% url 'view_profile' fb.loan.id %}" class="btn btn-view btn-sm">üë§ Full Profile</a>
            <a href="{% url 'invoice' %}?txn_id={{ fb.payment_txn }}" class="btn btn-paid btn-sm" target="_blank">‚úÖ Paid ‚Äî View Invoice</a>
          {% else %}
            <button class="btn btn-approve btn-sm razorpay-btn" data-loan-id="{{ fb.loan.id }}">üí≥ Make Payment ‚Çπ49</button>
            <button class="btn btn-reject btn-sm" data-bs-toggle="modal" data-bs-target="#rejectModal{{ fb.loan.id }}">Reject</button>
            <a href="{% url 'partial_profile' fb.loan.id %}" class="btn btn-view btn-sm">üëÅÔ∏è Partial Profile</a>
          {% endif %}

        {% elif fb.loan.global_status == "Rejected" %}
          <p class="text-danger fw-bold">‚ùå Applicant has chosen another lender</p>
          <a href="{% url 'partial_profile' fb.loan.id %}" class="btn btn-view btn-sm">üëÅÔ∏è Partial Profile</a>

        {% elif fb.loan.global_status == "Approved" %}
          <a href="{% url 'view_profile' fb.loan.id %}" class="btn btn-view btn-sm">üë§ Full Profile</a>
        {% endif %}
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
{% endblock %}

{% block extra_js %}
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function () {
  const filterBoxes = document.querySelectorAll(".filter-box");
  const mainRows = document.querySelectorAll("table tbody tr[data-status]");
  function applyFilter(kind) {
    const todayISO = new Date().toISOString().split("T")[0];
    mainRows.forEach(row => {
      const status = (row.dataset.status || "").toLowerCase();
      const created = row.dataset.created;
      let show = true;
      if (kind === "today") show = (created === todayISO);
      else if (["approved", "rejected", "pending"].includes(kind)) show = (status === kind);
      row.style.display = show ? "" : "none";
    });
  }
  filterBoxes.forEach(box => box.addEventListener("click", () => applyFilter(box.dataset.filter)));

  // ‚úÖ Razorpay Integration (per-loan)
  const payButtons = document.querySelectorAll(".razorpay-btn");
  payButtons.forEach(button => {
    button.addEventListener("click", async () => {
      try {
        const loanId = button.dataset.loanId;
        const response = await fetch("{% url 'initiate_payment' %}", {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            "X-CSRFToken": "{{ csrf_token }}"
          },
          body: new URLSearchParams({ amount: "49", loan_id: loanId })
        });
        const data = await response.json();
        if (!data.ok) return alert("‚ùå Payment initiation failed!");
        const options = {
          key: data.key,
          amount: data.amount,
          currency: data.currency,
          name: "Loan Saathi Hub",
          description: "Lender Access Fee",
          order_id: data.order_id,
          handler: function (response) {
            response.loan_id = loanId;
            fetch("{% url 'payment_callback' %}", {
              method: "POST",
              headers: { "Content-Type": "application/x-www-form-urlencoded" },
              body: new URLSearchParams(response)
            }).then(() => {
              window.location.href = "/payment/success/?txn_id=" + data.order_id;
            });
          },
          prefill: {
            name: "{{ request.user.profile.full_name|default:request.user.email }}",
            email: "{{ request.user.email }}",
            contact: "{{ request.user.profile.mobile|default:'9999999999' }}"
          },
          theme: { color: "#0d6efd" }
        };
        new Razorpay(options).open();
      } catch (err) {
        alert("‚ö†Ô∏è Payment initiation error!");
        console.error(err);
      }
    });
  });
});
</script>
{% endblock %}
