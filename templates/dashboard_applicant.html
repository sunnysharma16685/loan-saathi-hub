{% extends "base.html" %}
{% load static %}

{% block title %}Applicant Dashboard â€” Loan Saathi Hub{% endblock %}

{% block extra_head %}
<style>
  h1 {
    margin: 20px;
    font-size: 28px;
    color: #212529;
    text-align: center;
    font-weight: 700;
  }

  .btn-request {
    border: 2px solid #0d6efd;
    background: linear-gradient(90deg,#ff9933,#ffb84d);
    color: #111;
    font-weight: 600;
    border-radius: 8px;
    padding: 10px 18px;
    text-decoration: none;
    transition: all 0.3s ease-in-out;
  }
  .btn-request:hover {
    background: #e68a00;
    color: #fff;
    border-color: #0b5ed7;
  }
  .btn-accept { background: #28a745; color:#fff; }
  .btn-accept:hover { background:#218838; }
  .btn-info { background:#0dcaf0; color:#212529; }
  .btn-info:hover { background:#31d2f2; }

  .card {
    border-radius: 12px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.08);
    transition: transform .2s ease;
  }
  .card:hover { transform: translateY(-3px); }
  .filter-box { cursor:pointer; }
  .card-body h5 { font-weight:600; }
  .card-body h3 { font-weight:700; margin:0; }

  table {
    width:95%;
    margin:20px auto;
    border-collapse:collapse;
    background:#fff;
    border-radius:8px;
    overflow:hidden;
    box-shadow:0 6px 18px rgba(0,0,0,0.08);
  }
  table th, table td {
    padding:12px 10px;
    text-align:center;
    vertical-align:middle;
  }
  table th {
    background:#0d6efd;
    color:#fff;
    font-weight:600;
  }
  table tbody tr:hover { background:#f9fafb; transition:.3s; }
  .collapse table th { background:#e9ecef; }
  .collapse table td { background:#f8f9fa; }
</style>
{% endblock %}

{% block content %}
<h1>Applicant Dashboard</h1>

<!-- âœ… Messages -->
{% if messages %}
  {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
      {{ message }}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  {% endfor %}
{% endif %}

<!-- âœ… Action Row -->
<div class="d-flex justify-content-between align-items-center mb-3 px-3">
  <a href="{% url 'loan_request' %}" class="btn btn-request">+ New Loan Request</a>
  <div>
    <a href="{% url 'dashboard_applicant' %}" class="btn btn-outline-secondary me-2">All Loans</a>
    <a href="{% url 'edit_profile' user.id %}" class="btn btn-warning">Edit Profile</a>
  </div>
</div>

<!-- âœ… Stats -->
<div class="row mb-4 px-3 g-3">
  <div class="col-md-3">
    <div class="card text-center bg-primary text-white filter-box" data-filter="today">
      <div class="card-body">
        <h5>Total Loans Today</h5><h3>{{ total_today }}</h3>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-center bg-success text-white filter-box" data-filter="approved">
      <div class="card-body">
        <h5>Total Approved</h5><h3>{{ total_approved }}</h3>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-center bg-danger text-white filter-box" data-filter="rejected">
      <div class="card-body">
        <h5>Total Rejected</h5><h3>{{ total_rejected }}</h3>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-center bg-warning text-dark filter-box" data-filter="pending">
      <div class="card-body">
        <h5>Total Pending</h5><h3>{{ total_pending }}</h3>
      </div>
    </div>
  </div>
</div>

<!-- âœ… Loan Table -->
<table class="table table-striped rounded">
  <thead>
    <tr>
      <th>Sl No.</th>
      <th>Created Date</th>
      <th>Loan ID</th>
      <th>Loan Type</th>
      <th>Amount Requested â‚¹</th>
      <th>Duration (Months)</th>
      <th>Interest Rate</th>
      <th>Status</th>
      <th>Reason</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody>
    {% for loan in loans %}
    <tr data-status="{{ loan.global_status|lower }}" data-created="{{ loan.created_at|date:'Y-m-d' }}">
      <td>{{ forloop.counter }}</td>
      <td>{{ loan.created_at|date:"d-m-Y" }}</td>
      <td>{{ loan.loan_id }}</td>
      <td>{{ loan.loan_type }}</td>
      <td>â‚¹{{ loan.amount_requested }}</td>
      <td>{{ loan.duration_months }} months</td>
      <td>{{ loan.interest_rate }}%</td>
      <td>
        {% if loan.global_status == "Approved" %}
          <span class="badge bg-success">Pending â€” Compare Lenders</span>
        {% elif loan.global_status == "ComparePending" %}
          <span class="badge bg-warning text-dark">Pending â€” Compare Lenders (Rejected)</span>
        {% elif loan.global_status == "Finalised" %}
          <span class="badge bg-info text-dark">Finalised by You</span>
        {% elif loan.global_status == "Rejected" %}
          <span class="badge bg-danger">Rejected</span>
        {% elif loan.global_status == "Pending" %}
          <span class="badge bg-secondary">Pending â€” Lenders Reviewing</span>
        {% endif %}
      </td>
      <td>{{ loan.reason_for_loan }}</td>
      <td>
        <button class="btn btn-sm btn-outline-primary" data-bs-toggle="collapse"
                data-bs-target="#lenderFeedback{{loan.id}}">
          View Feedback
        </button>
      </td>
    </tr>

    <!-- âœ… Feedback Row -->
    <tr class="collapse" id="lenderFeedback{{loan.id}}">
      <td colspan="10">

        {% if loan.global_status in "Approved ComparePending" %}
        <div class="alert alert-info mb-2 small text-center">
          ðŸ’¡ Tip: You can compare lender offers and choose one to finalise your loan.
        </div>
        {% endif %}

        <table class="table table-sm table-bordered mb-0">
          <thead class="table-light">
            <tr>
              <th>Sl. No.</th>
              <th>Date</th>
              <th>Lender</th>
              <th>Status</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            {% for fb in loan.lender_statuses.all %}
              {% if fb.status == "Approved" or fb.status == "Rejected" %}
              <tr>
                <td>{{ forloop.counter }}</td>
                <td>{{ fb.updated_at|date:"d-m-Y H:i" }}</td>
                <td>{{ fb.lender.lender_details.lender_type|default:"N/A" }}</td>
                <td>
                  {% if fb.status == "Rejected" %}
                    <span class="badge bg-danger">Rejected</span>
                  {% elif fb.status == "Approved" %}
                    <span class="badge bg-success">Approved</span>
                  {% endif %}
                </td>
                <td>
                  {% if fb.status == "Rejected" %}
                    {{ fb.remarks|default:"Reason not provided" }}
                  {% elif fb.status == "Approved" %}
                    <button class="btn btn-sm btn-outline-info {% if loan.status == 'Finalised' and loan.accepted_lender.id == fb.lender.id %}active{% endif %}"
                            data-bs-toggle="modal" data-bs-target="#lenderContacts{{fb.id}}">
                      Lender Contacts
                    </button>
                  {% endif %}
                </td>
              </tr>

              {% if fb.status == "Approved" %}
              <!-- âœ… Modal -->
              <div class="modal fade" id="lenderContacts{{fb.id}}" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-md modal-dialog-scrollable">
                  <div class="modal-content">
                    <div class="modal-header {% if loan.status == 'Finalised' and loan.accepted_lender.id == fb.lender.id %}bg-info text-white{% else %}bg-light{% endif %}">
                      <h5 class="modal-title">Lender Contacts</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body text-start">
                      {% if loan.status == "Finalised" %}
                        {% if loan.accepted_lender.id == fb.lender.id %}
                          <div class="alert alert-success">ðŸŽ‰ Congratulations! This lender is selected.</div>
                          <p><strong>Name:</strong> {{ fb.lender.profile.full_name|default:"N/A" }}</p>
                          <p><strong>Mobile:</strong> {{ fb.lender.profile.mobile|default:"N/A" }}</p>
                          <p><strong>Bank/Firm:</strong> {{ fb.lender.lender_details.bank_firm_name|default:"N/A" }}</p>
                          <p><strong>Branch:</strong> {{ fb.lender.lender_details.branch_name|default:"N/A" }}</p>
                          <button class="btn btn-secondary w-100 mt-3" disabled>Already Selected</button>
                        {% else %}
                          <div class="alert alert-warning">Another lender already selected.</div>
                          <button class="btn btn-secondary w-100 mt-2" disabled>Contact Disabled</button>
                        {% endif %}
                      {% else %}
                        <p><strong>Name:</strong> {{ fb.lender.profile.full_name|default:"N/A" }}</p>
                        <p><strong>Mobile:</strong> {{ fb.lender.profile.mobile|default:"N/A" }}</p>
                        <p><strong>Bank/Firm:</strong> {{ fb.lender.lender_details.bank_firm_name|default:"N/A" }}</p>
                        <p><strong>Branch:</strong> {{ fb.lender.lender_details.branch_name|default:"N/A" }}</p>
                        <form class="ajax-accept-form" data-loan-id="{{ loan.id }}" data-lender-id="{{ fb.lender.id }}">
                          {% csrf_token %}
                          <button type="submit" class="btn btn-accept w-100 mt-3">Accept</button>
                        </form>
                        <p class="text-muted mt-2 small">âš  Once accepted, other lenders will be disabled.</p>
                      {% endif %}
                    </div>
                  </div>
                </div>
              </div>
              {% endif %}
              {% endif %}
            {% empty %}
            <tr><td colspan="5" class="text-center text-muted">No lender feedback yet.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </td>
    </tr>
    {% empty %}
    <tr><td colspan="10" class="text-center text-muted">No loan requests found.</td></tr>
    {% endfor %}
  </tbody>
</table>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
document.addEventListener("DOMContentLoaded", function () {
  const filterBoxes = document.querySelectorAll(".filter-box");
  const rows = document.querySelectorAll("table tbody tr[data-status]");

  // âœ… Filter Function
  function applyFilter(kind) {
    const todayISO = new Date().toISOString().split("T")[0];
    rows.forEach(row => {
      const status = (row.dataset.status || "").toLowerCase();
      const created = row.dataset.created;
      let show = true;
      if (kind === "today") show = (created === todayISO);
      else if (["approved","rejected","pending","accepted","finalised","comparepending"].includes(kind))
        show = (status === kind);
      row.style.display = show ? "" : "none";
    });
  }
  filterBoxes.forEach(box => box.addEventListener("click", () => applyFilter(box.dataset.filter)));

  // âœ… AJAX Accept Loan Finalisation
  document.querySelectorAll(".ajax-accept-form").forEach(form => {
    form.addEventListener("submit", async function(e) {
      e.preventDefault();

      const loanId = this.dataset.loanId;
      const lenderId = this.dataset.lenderId;
      const csrfToken = this.querySelector('[name=csrfmiddlewaretoken]').value;
      const url = `/applicant/accept-loan/${loanId}/${lenderId}/`;

      try {
        const res = await fetch(url, {
          method: "POST",
          headers: {
            "X-CSRFToken": csrfToken,
            "X-Requested-With": "XMLHttpRequest",
          },
        });

        // ðŸ§© Validate JSON response properly
        const text = await res.text();
        let data;
        try { data = JSON.parse(text); }
        catch { throw new Error("Invalid server response."); }

        if (data.ok) {
          Swal.fire({
            icon: "success",
            title: "Loan Finalised!",
            text: data.msg,
            timer: 2500,
            showConfirmButton: false,
          });

          // âœ… Update table badge
          const badge = document.querySelector(
            `[data-bs-target="#lenderFeedback${loanId}"]`
          )?.closest("tr")?.querySelector("td span.badge");
          if (badge) {
            badge.className = "badge bg-info text-dark";
            badge.textContent = "Finalised by You";
          }

          // âœ… Disable all accept buttons for this loan
          document.querySelectorAll(`#lenderFeedback${loanId} .btn-accept`).forEach(btn => {
            btn.textContent = "Locked";
            btn.disabled = true;
            btn.classList.remove("btn-accept");
            btn.classList.add("btn-secondary");
          });

          // âœ… Close the modal
          const modalEl = this.closest(".modal");
          const activeModal = bootstrap.Modal.getInstance(modalEl);
          if (activeModal) activeModal.hide();

        } else {
          Swal.fire({
            icon: "warning",
            title: "Oops!",
            text: data.msg || "Something went wrong.",
          });
        }

      } catch (err) {
        Swal.fire({
          icon: "error",
          title: "Error",
          text: err.message || "Unexpected error occurred.",
        });
      }
    });
  });
});
</script>
{% endblock %}
